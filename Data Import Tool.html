<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce B2C Commerce Data Import Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Salesforce+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Salesforce Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .file-drop-zone {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-drop-zone-active {
            background-color: #e0e7ff;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="container mx-auto px-4 py-8 md:py-12">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Salesforce B2C Commerce Data Import Tool</h1>
            <p class="mt-2 text-md md:text-lg text-slate-600">A three-step process to import data into Business Manager.</p>
        </header>

        <!-- Step 1: Select Import Type -->
        <section class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200 mb-8 fade-in">
            <h2 class="text-2xl font-bold mb-6 text-slate-900">Step 1. Select Import Type</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Product Section -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <h3 class="text-xs font-medium text-slate-600 mb-2 uppercase tracking-wide">Product</h3>
                    <div class="space-y-1" id="product-options">
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="Product" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Product Attributes</span>
                </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="VariationMapping" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Variation Mappings</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="ProductRecommendation" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Recommendations</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="ImageMapping" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Image Mappings</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="VariationGroup" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Variation Groups</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="Prices" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Prices</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="Inventory" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Inventory</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="ProductSets" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Product Sets</span>
                        </label>
                    </div>
                </div>
                
                <!-- Category Section -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <h3 class="text-xs font-medium text-slate-600 mb-2 uppercase tracking-wide">Category</h3>
                    <div class="space-y-1" id="category-options">
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="Category" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Category Attributes</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="CategoryAssignment" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Category Assignments</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="CategoryPosition" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Category Position</span>
                        </label>
                    </div>
                </div>

                <!-- Content Section -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <h3 class="text-xs font-medium text-slate-600 mb-2 uppercase tracking-wide">Content</h3>
                    <div class="space-y-1" id="content-options">
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="ContentAsset" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Content Assets</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="LibraryFolder" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Library Folders</span>
                        </label>
                    </div>
                </div>

                <!-- Customer Groups Section -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <h3 class="text-xs font-medium text-slate-600 mb-2 uppercase tracking-wide">Customer Groups</h3>
                    <div class="space-y-1" id="customer-groups-options">
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="Customer" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Customers</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer p-1.5 rounded hover:bg-white transition-colors">
                            <input type="radio" name="objectType" value="StaticCustomerGroup" class="h-3 w-3 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                            <span class="text-sm font-medium text-slate-700">Static Customer Group</span>
                        </label>
                    </div>
                </div>

                <!-- On-site Search Section -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <h3 class="text-xs font-medium text-slate-600 mb-2 uppercase tracking-wide">On-site Search</h3>
                    <div class="space-y-1" id="onsite-search-options">
                        <div class="p-1.5 text-sm text-slate-500 italic">
                            Coming Soon
                        </div>
                    </div>
                </div>

                <!-- Online Marketing Section -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <h3 class="text-xs font-medium text-slate-600 mb-2 uppercase tracking-wide">Online Marketing</h3>
                    <div class="space-y-1" id="online-marketing-options">
                        <div class="p-1.5 text-sm text-slate-500 italic">
                            Coming Soon
                        </div>
                    </div>
                </div>

                <!-- SEO Section -->
                <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                    <h3 class="text-xs font-medium text-slate-600 mb-2 uppercase tracking-wide">SEO</h3>
                    <div class="space-y-1" id="seo-options">
                        <div class="p-1.5 text-sm text-slate-500 italic">
                            Coming Soon
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 2: Define Attributes (CSV Generation) -->
        <main id="attribute-section" class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200 hidden fade-in mb-8">
            <h2 class="text-2xl font-bold mb-6 text-slate-900">Step 2. Generate CSV Template</h2>
            
            <!-- Collapsible Help Section for Product Attributes -->
            <div id="product-attributes-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How to Use Product Attributes</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <p class="text-sm text-blue-800 mb-3">Follow these steps to create your product import CSV:</p>
                        <ol class="text-sm text-blue-800 space-y-2 ml-4 list-decimal">
                            <li><strong>Select attributes:</strong> Choose standard attributes from the left column and/or add custom attributes using the table</li>
                            <li><strong>Configure options:</strong> Optionally specify locale and site-specific settings below the attribute selection</li>
                            <li><strong>Generate template:</strong> Click "Generate CSV Template" to download your customized template</li>
                            <li><strong>Populate data:</strong> Open the CSV, fill in your product data, and proceed to Step 3</li>
                        </ol>
                        <div class="bg-white p-3 rounded border border-blue-200 mt-3">
                            <p class="text-xs font-semibold text-blue-900 mb-1">üí° Bulk Delete Feature</p>
                            <p class="text-xs text-blue-700">Leave a selected attribute's value <strong>blank</strong> in the CSV to clear/delete that attribute value for products. The XML will include the empty element, instructing Commerce Cloud to remove the value.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Category Attributes -->
            <div id="category-attributes-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How to Use Category Attributes</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <p class="text-sm text-blue-800 mb-3">Follow these steps to create your category import CSV:</p>
                        <ol class="text-sm text-blue-800 space-y-2 ml-4 list-decimal">
                            <li><strong>Select attributes:</strong> Choose standard attributes from the left column and/or add custom attributes using the table</li>
                            <li><strong>Configure options:</strong> Optionally specify locale and site-specific settings</li>
                            <li><strong>Generate template:</strong> Click "Generate CSV Template" to download your customized template</li>
                            <li><strong>Populate data:</strong> Open the CSV, fill in your category data, and proceed to Step 3</li>
                        </ol>
                        <div class="bg-white p-3 rounded border border-blue-200 mt-3">
                            <p class="text-xs font-semibold text-blue-900 mb-1">üí° Bulk Delete Feature</p>
                            <p class="text-xs text-blue-700">Leave a selected attribute's value <strong>blank</strong> in the CSV to clear/delete that attribute value for categories. The XML will include the empty element, instructing Commerce Cloud to remove the value.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Product Recommendations -->
            <div id="product-recommendation-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù Manual Product Recommendations</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <p class="text-sm text-blue-800 mb-3">These manual product recommendation types are <strong>not Einstein Product Recommendations</strong>, but rather a manual alternative to Einstein for creating custom product relationships.</p>
                        <div class="space-y-2 mt-3">
                            <div class="bg-white p-3 rounded border border-blue-200">
                                <div class="flex items-start space-x-2">
                                    <span class="font-bold text-blue-800 bg-blue-100 px-2 py-1 rounded text-xs">1</span>
                                    <div>
                                        <span class="font-semibold text-slate-800">Product Detail Page - Cross Sell</span>
                                        <p class="text-xs text-slate-600 mt-1">In reference application: displays on product detail page in the "You Might Also Like" section. <em>This is the most common selection.</em></p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded border border-blue-200">
                                <div class="flex items-start space-x-2">
                                    <span class="font-bold text-blue-800 bg-blue-100 px-2 py-1 rounded text-xs">2</span>
                                    <div>
                                        <span class="font-semibold text-slate-800">Category Landing Page - Featured Item</span>
                                        <p class="text-xs text-slate-600 mt-1">Not implemented in reference application. <em>Requires a new template.</em></p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-3 rounded border border-blue-200">
                                <div class="flex items-start space-x-2">
                                    <span class="font-bold text-blue-800 bg-blue-100 px-2 py-1 rounded text-xs">3</span>
                                    <div>
                                        <span class="font-semibold text-slate-800">Other</span>
                                        <p class="text-xs text-slate-600 mt-1">Not implemented in reference application. <em>Requires a new template.</em></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Variation Mapping -->
            <div id="variation-mapping-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Variation Mapping Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ <strong>Each row</strong> represents one variant product</li>
                            <li>‚Ä¢ <strong>Columns A & B (Required):</strong> Variation Product ID and Base Product ID</li>
                            <li>‚Ä¢ <strong>Columns C & D (Optional):</strong> onlineFlag and searchableFlag (accepts true/false/yes/no/1/0)</li>
                            <li>‚Ä¢ <strong>Columns E-H (Optional):</strong> Variation Attribute ID 1, Name 1, Value 1, and Value Display 1</li>
                            <li>‚Ä¢ <strong>Multiple Variation Attributes:</strong> Add columns for ID 2, Name 2, Value 2, Display 2, then ID 3, Name 3, etc.</li>
                            <li>‚Ä¢ If variation attributes are provided, the tool will generate the complete variation attribute structure with all values</li>
                            <li>‚Ä¢ If variation attributes are omitted, the tool will only create the products and basic variant mapping</li>
                            <li>‚Ä¢ The tool will automatically create all products if they don't exist</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Category Assignment -->
            <div id="category-assignment-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Category Assignment Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ <strong>Each row</strong> represents one product-to-category assignment</li>
                            <li>‚Ä¢ <strong>Multiple assignments</strong> per product supported - create additional rows</li>
                            <li>‚Ä¢ <strong>Primary category</strong> - set "Primary Category ID" to TRUE to mark as primary</li>
                            <li>‚Ä¢ <strong>Product ID and Category ID</strong> are required for each assignment</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Category Position -->
            <div id="category-position-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Category Position Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <p class="text-sm text-blue-800 mb-3">Bulk change product positions within categories. Each row represents one product's position in a category.</p>
                        
                        <div class="bg-white p-3 rounded border border-blue-200 mb-2">
                            <p class="text-xs font-semibold text-blue-900 mb-2">üìå Sorting Types</p>
                            <div class="space-y-2 text-xs text-blue-700">
                                <div><strong>auto:</strong> Sequences products sequentially. List products top-to-bottom in display order.</div>
                                <div><strong>top:</strong> Moves products to first position. List in <em>reverse</em> order (last listed = first displayed).</div>
                                <div><strong>bottom:</strong> Moves products to last position. List in display order.</div>
                                <div><strong>none:</strong> Removes position definition (unsorts products).</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Image Mapping -->
            <div id="image-mapping-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Image Mapping Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ <strong>Each row</strong> represents one product and its associated images</li>
                            <li>‚Ä¢ <strong>Variation Group or Variation Master ID</strong> required</li>
                            <li>‚Ä¢ <strong>Up to 4 images</strong> per variation supported</li>
                            <li>‚Ä¢ Images will be mapped to variation attribute values</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Variation Group -->
            <div id="variation-group-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Variation Groups Work</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ <strong>Each row</strong> represents one variation group attribute definition</li>
                            <li>‚Ä¢ <strong>Variation Attribute ID</strong> is required (e.g., "color", "size")</li>
                            <li>‚Ä¢ <strong>Display Name</strong> is optional but recommended for better UX</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Prices -->
            <div id="prices-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Price Import Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1 mb-3">
                            <li>‚Ä¢ <strong>Each row</strong> represents one product's price</li>
                            <li>‚Ä¢ <strong>Product ID and Price</strong> are required</li>
                            <li>‚Ä¢ <strong>Online From and Online To</strong> are optional date fields for price validity</li>
                        </ul>
                        <div class="bg-white p-3 rounded border border-blue-200 mb-2">
                            <p class="text-xs font-semibold text-blue-900 mb-1">üí∞ Quantity Pricing</p>
                            <p class="text-xs text-blue-700 mb-2">Set tiered pricing based on purchase quantity. Use the optional Quantity/Price columns:</p>
                            <ul class="text-xs text-blue-700 space-y-1 list-disc list-inside ml-2">
                                <li><strong>Price</strong> - Base price (quantity 1)</li>
                                <li><strong>Quantity 2 / Price 2</strong> - Price when buying 2+ units</li>
                                <li><strong>Quantity 3 / Price 3</strong> - Price when buying 3+ units</li>
                                <li>...up to <strong>Quantity 10 / Price 10</strong></li>
                            </ul>
                            <p class="text-xs text-blue-600 mt-2 italic">Example: Base price $10, Quantity 5 = $9.50, Quantity 10 = $9.00</p>
                        </div>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <p class="text-xs font-semibold text-blue-900 mb-1">üìÖ Date Formats</p>
                            <p class="text-xs text-blue-700">Supported: YYYY-MM-DD, MM/DD/YYYY, MM/DD/YY (auto-converts to ISO format). Two-digit years = 20XX.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Inventory -->
            <div id="inventory-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Inventory Import Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1 mb-3">
                            <li>‚Ä¢ <strong>Product ID</strong> is required</li>
                            <li>‚Ä¢ <strong>Allocation</strong> is optional - defaults to 0 if blank (useful for perpetual inventory)</li>
                            <li>‚Ä¢ <strong>Perpetual</strong> - accepts true/false/yes/no/1/0 (auto-normalized) - set to TRUE for unlimited stock</li>
                            <li>‚Ä¢ <strong>Pre-order/Backorder</strong> - accepts "preorder", "pre-order", "backorder", "back-order", or "none" (auto-normalized)</li>
                        </ul>
                        <div class="bg-white p-3 rounded border border-blue-200 mb-2">
                            <p class="text-xs font-semibold text-blue-900 mb-1">üìÖ Date Formats</p>
                            <p class="text-xs text-blue-700">In-Stock Date supports: YYYY-MM-DD, MM/DD/YYYY, MM/DD/YY (auto-converts to YYYY-MM-DD). Two-digit years = 20XX.</p>
                        </div>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <p class="text-xs font-semibold text-blue-900 mb-1">üí° Tips</p>
                            <p class="text-xs text-blue-700"><strong>Perpetual:</strong> Leave Allocation blank/0, set Perpetual=true. <strong>Preorder/Backorder only:</strong> Leave Allocation blank, set Pre-order/Backorder Allocation value.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Content Asset -->
            <div id="content-asset-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Content Asset Import Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ <strong>Each row</strong> represents one content asset</li>
                            <li>‚Ä¢ <strong>Asset ID and Library ID</strong> are required</li>
                            <li>‚Ä¢ <strong>Locale</strong> must be specified for localized content</li>
                            <li>‚Ä¢ <strong>Name and Body</strong> are the main content fields</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Library Folder -->
            <div id="library-folder-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Library Folder Import Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1 mb-3">
                            <li>‚Ä¢ <strong>Each row</strong> represents one library folder</li>
                            <li>‚Ä¢ <strong>Folder ID and Library ID</strong> are required</li>
                            <li>‚Ä¢ <strong>Locale</strong> must be specified for localized folders</li>
                        </ul>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <p class="text-xs font-semibold text-blue-900 mb-2">üìã CSV Columns</p>
                            <div class="space-y-1 text-xs text-blue-700">
                                <div><strong>ID:</strong> Unique identifier for the folder</div>
                                <div><strong>Display Name:</strong> Human-readable name for the folder</div>
                                <div><strong>Description:</strong> Description of the folder's purpose</div>
                                <div><strong>Parent:</strong> Parent folder ID (use "root" for top-level folders)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Static Customer Group -->
            <div id="static-customer-group-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Static Customer Group Import Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1 mb-3">
                            <li>‚Ä¢ <strong>Each row</strong> represents one customer to add to the group</li>
                            <li>‚Ä¢ <strong>Customer Group ID</strong> must be specified in the configuration</li>
                            <li>‚Ä¢ All customers in the CSV will be added to the same group</li>
                        </ul>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <p class="text-xs font-semibold text-blue-900 mb-1">üìã CSV Column</p>
                            <p class="text-xs text-blue-700"><strong>Customer Number:</strong> The customer number to assign to the customer group</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Product Sets -->
            <div id="product-sets-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Product Sets Work</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1 mb-3">
                            <li>‚Ä¢ <strong>Each row</strong> represents one product set and its member products</li>
                            <li>‚Ä¢ <strong>Product Set ID</strong> (Column A) is required</li>
                            <li>‚Ä¢ <strong>Standard attributes</strong> can be selected from the checkboxes (e.g., displayName, onlineFlag, searchableFlag, brand, etc.)</li>
                            <li>‚Ä¢ <strong>Custom attributes</strong> (if any) can be added using the table</li>
                            <li>‚Ä¢ <strong>Variant Product IDs</strong> appear in the final columns - up to 100 products per set</li>
                        </ul>
                        <div class="bg-white p-3 rounded border border-blue-200">
                            <p class="text-xs font-semibold text-blue-900 mb-1">üí° Tip</p>
                            <p class="text-xs text-blue-700">Leave product ID columns empty if not needed. Product sets allow you to group related products together for merchandising.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Help Section for Customer -->
            <div id="customer-help" class="mb-6 hidden">
                <div class="bg-blue-50 rounded-lg border border-blue-200">
                    <button type="button" class="w-full p-4 text-left flex items-center justify-between hover:bg-blue-100 transition-colors rounded-lg" onclick="this.parentElement.querySelector('.help-content').classList.toggle('hidden'); this.querySelector('.toggle-icon').classList.toggle('rotate-180');">
                        <h3 class="font-semibold text-blue-900">üìù How Customer Import Works</h3>
                        <svg class="toggle-icon w-5 h-5 text-blue-900 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>
                    <div class="help-content p-4 pt-0">
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ <strong>Each row</strong> represents one customer record</li>
                            <li>‚Ä¢ <strong>Select attributes:</strong> Choose standard customer attributes and/or add custom attributes</li>
                            <li>‚Ä¢ <strong>Customer Number and Email</strong> are typically required fields</li>
                            <li>‚Ä¢ <strong>Generate template:</strong> Click "Generate CSV Template" to download your customized template</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Locale Selection -->
            <div id="locale-section" class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="flex items-center space-x-3 mb-3">
                    <input type="checkbox" id="locale-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="locale-checkbox" class="text-sm font-medium text-slate-700">Specify Locale (leave unchecked for default locale)</label>
                </div>
                <div id="locale-dropdown-container" class="hidden">
                    <label for="locale-select" class="block text-sm font-medium text-slate-700 mb-2">Locale</label>
                    <select id="locale-select" class="w-full md:w-48 px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="default" selected>Default</option>
                        <option value="ar">Arabic</option>
                        <option value="bg">Bulgarian</option>
                        <option value="zh">Chinese</option>
                        <option value="zh_CN">Chinese (China)</option>
                        <option value="zh_TW">Chinese (Taiwan)</option>
                        <option value="hr">Croatian</option>
                        <option value="cs">Czech</option>
                        <option value="da">Danish</option>
                        <option value="nl">Dutch</option>
                        <option value="en">English</option>
                        <option value="en_CA">English (Canada)</option>
                        <option value="en_GB">English (United Kingdom)</option>
                        <option value="en_US">English (United States)</option>
                        <option value="fi">Finnish</option>
                        <option value="fr">French</option>
                        <option value="fr_CA">French (Canada)</option>
                        <option value="de">German</option>
                        <option value="el">Greek</option>
                        <option value="iw">Hebrew</option>
                        <option value="hu">Hungarian</option>
                        <option value="in">Indonesian</option>
                        <option value="it">Italian</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="no">Norwegian</option>
                        <option value="pl">Polish</option>
                        <option value="pt">Portuguese</option>
                        <option value="pt_BR">Portuguese (Brazil)</option>
                        <option value="pt_PT">Portuguese (Portugal)</option>
                        <option value="ro">Romanian</option>
                        <option value="ru">Russian</option>
                        <option value="sk">Slovak</option>
                        <option value="sl">Slovenian</option>
                        <option value="es">Spanish</option>
                        <option value="es_MX">Spanish (Mexico)</option>
                        <option value="es_ES">Spanish (Spain)</option>
                        <option value="sv">Swedish</option>
                        <option value="th">Thai</option>
                    </select>
                </div>
            </div>
            
            <!-- Site-Specific Selection -->
            <div id="site-section" class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                <div class="flex items-center space-x-3 mb-3">
                    <input type="checkbox" id="site-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="site-checkbox" class="text-sm font-medium text-slate-700">Specify site-specific attributes</label>
                </div>
                <div id="site-input-container" class="hidden">
                    <label for="site-id-input" class="block text-sm font-medium text-slate-700 mb-2">Site ID</label>
                    <input type="text" id="site-id-input" placeholder="e.g., 'RefArch'" class="w-full md:w-48 px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                </div>
            </div>

            <!-- Content Asset Configuration Section -->
            <div id="content-asset-section" class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
                <h4 class="font-semibold text-slate-800 mb-4">Content Asset Configuration</h4>
                
                <!-- Library ID Input -->
                <div class="mb-4 p-4 bg-white rounded-lg border border-slate-300">
                    <label for="content-library-id" class="block text-sm font-medium text-slate-700 mb-2">Library ID <span class="text-red-500">*</span></label>
                    <input type="text" id="content-library-id" placeholder="e.g., 'SharedLibrary'" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
                </div>
                
                <!-- Content Locale Selection -->
                <div class="mb-4 p-4 bg-white rounded-lg border border-slate-300">
                    <label for="content-locale-select" class="block text-sm font-medium text-slate-700 mb-2">Locale <span class="text-red-500">*</span></label>
                    <select id="content-locale-select" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="default" selected>Default</option>
                        <option value="ar">Arabic</option>
                        <option value="bg">Bulgarian</option>
                        <option value="zh">Chinese</option>
                        <option value="zh_CN">Chinese (China)</option>
                        <option value="zh_TW">Chinese (Taiwan)</option>
                        <option value="hr">Croatian</option>
                        <option value="cs">Czech</option>
                        <option value="da">Danish</option>
                        <option value="nl">Dutch</option>
                        <option value="en">English</option>
                        <option value="en_CA">English (Canada)</option>
                        <option value="en_GB">English (United Kingdom)</option>
                        <option value="en_US">English (United States)</option>
                        <option value="fi">Finnish</option>
                        <option value="fr">French</option>
                        <option value="fr_CA">French (Canada)</option>
                        <option value="de">German</option>
                        <option value="el">Greek</option>
                        <option value="iw">Hebrew</option>
                        <option value="hu">Hungarian</option>
                        <option value="in">Indonesian</option>
                        <option value="it">Italian</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="no">Norwegian</option>
                        <option value="pl">Polish</option>
                        <option value="pt">Portuguese</option>
                        <option value="pt_BR">Portuguese (Brazil)</option>
                        <option value="pt_PT">Portuguese (Portugal)</option>
                        <option value="ro">Romanian</option>
                        <option value="ru">Russian</option>
                        <option value="sk">Slovak</option>
                        <option value="sl">Slovenian</option>
                        <option value="es">Spanish</option>
                        <option value="es_MX">Spanish (Mexico)</option>
                        <option value="es_ES">Spanish (Spain)</option>
                        <option value="sv">Swedish</option>
                        <option value="th">Thai</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
                </div>
            </div>
            
            <!-- Library Folder Configuration Section -->
            <div id="library-folder-section" class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
                <h4 class="font-semibold text-slate-800 mb-4">Library Folder Configuration</h4>
                
                <!-- Library ID Input -->
                <div class="mb-4 p-4 bg-white rounded-lg border border-slate-300">
                    <label for="folder-library-id" class="block text-sm font-medium text-slate-700 mb-2">Library ID <span class="text-red-500">*</span></label>
                    <input type="text" id="folder-library-id" placeholder="e.g., 'SharedLibrary'" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
                </div>
                
                <!-- Library Folder Locale Selection -->
                <div class="mb-4 p-4 bg-white rounded-lg border border-slate-300">
                    <label for="folder-locale-select" class="block text-sm font-medium text-slate-700 mb-2">Locale <span class="text-red-500">*</span></label>
                    <select id="folder-locale-select" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="default" selected>Default</option>
                        <option value="ar">Arabic</option>
                        <option value="bg">Bulgarian</option>
                        <option value="zh">Chinese</option>
                        <option value="zh_CN">Chinese (China)</option>
                        <option value="zh_TW">Chinese (Taiwan)</option>
                        <option value="hr">Croatian</option>
                        <option value="cs">Czech</option>
                        <option value="da">Danish</option>
                        <option value="nl">Dutch</option>
                        <option value="en">English</option>
                        <option value="en_CA">English (Canada)</option>
                        <option value="en_GB">English (United Kingdom)</option>
                        <option value="en_US">English (United States)</option>
                        <option value="fi">Finnish</option>
                        <option value="fr">French</option>
                        <option value="fr_CA">French (Canada)</option>
                        <option value="de">German</option>
                        <option value="el">Greek</option>
                        <option value="iw">Hebrew</option>
                        <option value="hu">Hungarian</option>
                        <option value="in">Indonesian</option>
                        <option value="it">Italian</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="no">Norwegian</option>
                        <option value="pl">Polish</option>
                        <option value="pt">Portuguese</option>
                        <option value="pt_BR">Portuguese (Brazil)</option>
                        <option value="pt_PT">Portuguese (Portugal)</option>
                        <option value="ro">Romanian</option>
                        <option value="ru">Russian</option>
                        <option value="sk">Slovak</option>
                        <option value="sl">Slovenian</option>
                        <option value="es">Spanish</option>
                        <option value="es_MX">Spanish (Mexico)</option>
                        <option value="es_ES">Spanish (Spain)</option>
                        <option value="sv">Swedish</option>
                        <option value="th">Thai</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
                </div>
                
                <!-- CSV Structure Display -->
                <div class="mb-6">
                    <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-white p-3 rounded-lg border border-slate-300">
                            <span class="font-medium text-slate-700">Column A: ID</span>
                            <span class="block text-xs text-slate-500">Required - Unique folder identifier</span>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-slate-300">
                            <span class="font-medium text-slate-700">Column B: Display Name</span>
                            <span class="block text-xs text-slate-500">Required - Human-readable name</span>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-slate-300">
                            <span class="font-medium text-slate-700">Column C: Description</span>
                            <span class="block text-xs text-slate-500">Optional - Folder purpose</span>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-slate-300">
                            <span class="font-medium text-slate-700">Column D: Parent</span>
                            <span class="block text-xs text-slate-500">Parent folder ID or "root"</span>
                        </div>
                    </div>
                </div>
                
                <!-- Generate CSV Button -->
                <button id="generate-library-folder-csv-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">
                    Generate CSV Template
                </button>
            </div>
            
            <!-- Static Customer Group Configuration Section -->
            <div id="static-customer-group-section" class="mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200 hidden">
                <h4 class="font-semibold text-slate-800 mb-4">Static Customer Group Configuration</h4>
                
                <!-- Customer Group ID Input -->
                <div class="mb-4 p-4 bg-white rounded-lg border border-slate-300">
                    <label for="static-group-id" class="block text-sm font-medium text-slate-700 mb-2">Customer Group ID <span class="text-red-500">*</span></label>
                    <input type="text" id="static-group-id" placeholder="e.g., 'vip-customers'" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
                </div>
                
                <!-- CSV Structure Display -->
                <div class="mb-6">
                    <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <div class="bg-white p-3 rounded-lg border border-slate-300">
                            <span class="font-medium text-slate-700">Column A: Customer Number</span>
                            <span class="block text-xs text-slate-500">Required</span>
                        </div>
                    </div>
                </div>
                
                <!-- Generate CSV Button -->
                <button id="generate-static-customer-group-csv-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">
                    Generate CSV Template
                </button>
            </div>
            
            <!-- Product Sets Configuration Section -->
            <div id="product-sets-section" class="mb-6 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-slate-900 border-b pb-2">Standard Attributes</h3>
                        <div id="product-sets-standard-attributes" class="space-y-3 max-h-[800px] overflow-y-auto pr-4"></div>
                    </div>
                    
                    <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                        <h3 class="text-xl font-semibold mb-4 text-slate-900 border-b pb-2">Selected Columns</h3>
                        <div id="product-sets-selected-list" class="space-y-2">
                            <div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-slate-200" data-default="true">
                                <span class="font-semibold text-slate-700">Product Set ID</span>
                                <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-full">Default</span>
                            </div>
                        </div>
                        <div id="product-sets-no-attributes" class="text-center py-4 text-slate-500 mt-2"><p class="text-sm italic">No attributes selected yet.</p></div>
                        
                        <!-- CSV Structure Display -->
                        <div class="mt-6">
                            <h4 class="font-semibold text-slate-800 mb-3 text-sm border-b pb-2">CSV Structure:</h4>
                            <div class="space-y-2 text-xs">
                                <div class="bg-white p-2 rounded border border-slate-200">
                                    <span class="font-medium text-slate-700">Column A:</span> <span class="text-slate-600">Product Set ID (Required)</span>
                                </div>
                                <div class="bg-white p-2 rounded border border-slate-200">
                                    <span class="font-medium text-slate-700">Next:</span> <span class="text-slate-600">Standard or Custom Attributes (if added)</span>
                                </div>
                                <div class="bg-white p-2 rounded border border-slate-200">
                                    <span class="font-medium text-slate-700">Finally:</span> <span class="text-slate-600">Variant Product IDs (up to 100)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Custom Attributes Section (Full Width) -->
                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 border-b pb-2">Custom Attributes</h3>
                    
                    <!-- Custom Attributes Table -->
                    <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                        <div class="bg-slate-50 px-4 py-3 border-b border-slate-200">
                            <h4 class="text-sm font-medium text-slate-900">Add Multiple Custom Attributes</h4>
                            <p class="text-xs text-slate-600 mt-1">Add custom attributes with their types. Leave type blank to default to String.</p>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">Attribute ID</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">Type</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase tracking-wider w-20">Localizable</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase tracking-wider w-20">Site-Specific</th>
                                        <th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase tracking-wider w-16">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="product-sets-custom-attributes-table" class="divide-y divide-slate-200">
                                    <!-- Dynamic rows will be added here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="bg-slate-50 px-4 py-3 border-t border-slate-200 flex justify-between items-center">
                            <div class="flex space-x-2">
                                <button id="add-product-sets-row-btn" class="px-3 py-1 bg-slate-600 text-white text-sm font-medium rounded-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-colors">
                                    + Add Row
                                </button>
                                <button id="clear-product-sets-table-btn" class="px-3 py-1 bg-slate-400 text-white text-sm font-medium rounded-md hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2 transition-colors">
                                    Clear All
                                </button>
                            </div>
                            <button id="apply-product-sets-attributes-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform transform hover:scale-105 shadow">
                                Apply All
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Generate CSV Button -->
                <button id="generate-product-sets-csv-btn" class="w-full mt-6 bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-semibold shadow-lg">
                    Generate CSV Template
                </button>
            </div>
            
            
            <!-- Standard Attributes Section -->
            <div id="attributes-section" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 id="standard-attributes-header" class="text-xl font-semibold mb-4 text-slate-900 border-b pb-2">Standard Attributes</h3>
                    <div id="standard-attributes" class="space-y-3 max-h-[800px] overflow-y-auto pr-4"></div>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 border-b pb-2">Selected Columns</h3>
                    <div id="selected-attributes-list" class="space-y-2">
                        <div class="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-slate-200">
                            <span id="default-column-header" class="font-semibold text-slate-700"></span>
                            <span class="text-xs font-medium text-slate-500 bg-slate-100 px-2 py-1 rounded-full">Default</span>
                        </div>
                    </div>
                    <div id="no-attributes-message" class="text-center py-8 text-slate-500"><p>No attributes selected yet.</p></div>
                    
                    <!-- Locale Selection (moved below attributes) -->
                    <div id="locale-section-moved" class="mt-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="flex items-center space-x-3 mb-3">
                            <input type="checkbox" id="locale-checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="locale-checkbox" class="text-sm font-medium text-slate-700">Specify Locale (leave unchecked for default locale)</label>
                        </div>
                        <div id="locale-dropdown-container" class="hidden">
                            <label for="locale-select" class="block text-sm font-medium text-slate-700 mb-2">Locale</label>
                            <select id="locale-select" class="w-full md:w-48 px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                                <option value="default" selected>Default</option>
                                <option value="ar">Arabic</option>
                                <option value="bg">Bulgarian</option>
                                <option value="zh">Chinese</option>
                                <option value="zh_CN">Chinese (China)</option>
                                <option value="zh_TW">Chinese (Taiwan)</option>
                                <option value="hr">Croatian</option>
                                <option value="cs">Czech</option>
                                <option value="da">Danish</option>
                                <option value="nl">Dutch</option>
                                <option value="en">English</option>
                                <option value="en_CA">English (Canada)</option>
                                <option value="en_GB">English (United Kingdom)</option>
                                <option value="en_US">English (United States)</option>
                                <option value="fi">Finnish</option>
                                <option value="fr">French</option>
                                <option value="fr_CA">French (Canada)</option>
                                <option value="de">German</option>
                                <option value="el">Greek</option>
                                <option value="iw">Hebrew</option>
                                <option value="hu">Hungarian</option>
                                <option value="in">Indonesian</option>
                                <option value="it">Italian</option>
                                <option value="ja">Japanese</option>
                                <option value="ko">Korean</option>
                                <option value="no">Norwegian</option>
                                <option value="pl">Polish</option>
                                <option value="pt">Portuguese</option>
                                <option value="pt_BR">Portuguese (Brazil)</option>
                                <option value="pt_PT">Portuguese (Portugal)</option>
                                <option value="ro">Romanian</option>
                                <option value="ru">Russian</option>
                                <option value="sk">Slovak</option>
                                <option value="sl">Slovenian</option>
                                <option value="es">Spanish</option>
                                <option value="es_MX">Spanish (Mexico)</option>
                                <option value="es_ES">Spanish (Spain)</option>
                                <option value="sv">Swedish</option>
                                <option value="th">Thai</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Site-Specific Selection (moved below attributes) -->
                    <div id="site-section-moved" class="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="flex items-center space-x-3 mb-3">
                            <input type="checkbox" id="site-checkbox-moved" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="site-checkbox-moved" class="text-sm font-medium text-slate-700">Specify site-specific attributes</label>
                        </div>
                        <div id="site-input-container-moved" class="hidden">
                            <label for="site-id-input-moved" class="block text-sm font-medium text-slate-700 mb-2">Site ID</label>
                            <input type="text" id="site-id-input-moved" placeholder="e.g., 'RefArch'" class="w-full md:w-48 px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        </div>
                    </div>
                    
                    <button id="generate-sheet-btn" class="w-full mt-6 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                </div>
            </div>
            
            <!-- Custom Attributes Section (Full Width) -->
            <div id="custom-attributes-section" class="mt-8">
                <h3 id="custom-attributes-header" class="text-xl font-semibold mb-4 text-slate-900 border-b pb-2">Custom Attributes</h3>
                
                <!-- Custom Attributes Table -->
                <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-200">
                        <h4 class="text-sm font-medium text-slate-900">Add Multiple Custom Attributes</h4>
                        <p class="text-xs text-slate-600 mt-1">Add custom attributes with their types. Leave type blank to default to String.</p>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">Attribute ID</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-slate-700 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase tracking-wider w-20">Localizable</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase tracking-wider w-20">Site-Specific</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium text-slate-700 uppercase tracking-wider w-16">Action</th>
                                </tr>
                            </thead>
                            <tbody id="custom-attributes-table-body" class="divide-y divide-slate-200">
                                <!-- Dynamic rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="bg-slate-50 px-4 py-3 border-t border-slate-200 flex justify-between items-center">
                        <div class="flex space-x-2">
                            <button id="add-row-btn" class="px-3 py-1 bg-slate-600 text-white text-sm font-medium rounded-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 transition-colors">
                                + Add Row
                            </button>
                            <button id="clear-table-btn" class="px-3 py-1 bg-slate-400 text-white text-sm font-medium rounded-md hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2 transition-colors">
                                Clear All
                            </button>
                        </div>
                        <button id="apply-custom-attributes-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-transform transform hover:scale-105 shadow">
                            Apply All
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Product Recommendation Section -->
            <div id="product-recommendation-section" class="hidden">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 text-center">Recommendations CSV Template</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column A: Recommendation Type</span>
                                <span class="block text-xs text-slate-500">Required (1, 2, or 3)</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column B: Target ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column C: Source ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="generate-product-recommendation-csv-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                    </div>
                </div>
            </div>
            
            <!-- Variation Mapping Section -->
            <div id="variation-mapping-section" class="hidden">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 text-center">Variation Mappings CSV Template</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column A: Variation Product ID</span>
                                <span class="block text-xs text-slate-500">Required - The variant SKU</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column B: Base Product ID</span>
                                <span class="block text-xs text-slate-500">Required - The master SKU</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column C: onlineFlag</span>
                                <span class="block text-xs text-slate-500">Optional - true/false/yes/no/1/0</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column D: searchableFlag</span>
                                <span class="block text-xs text-slate-500">Optional - true/false/yes/no/1/0</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column E: Variation Attribute ID 1</span>
                                <span class="block text-xs text-slate-500">Optional - e.g., packSize</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column F: Variation Attribute Name 1</span>
                                <span class="block text-xs text-slate-500">Optional - e.g., Pack Size</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column G: Variation Value 1</span>
                                <span class="block text-xs text-slate-500">Optional - e.g., single, 2pack</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column H: Variation Value Display 1</span>
                                <span class="block text-xs text-slate-500">Optional - e.g., Single, 2 Pack</span>
                            </div>
                        </div>
                        <p class="text-xs text-slate-600 mt-2 italic">üí° Tip: Add more variation attributes by adding columns I-L (ID 2, Name 2, Value 2, Display 2), M-P (ID 3, Name 3, Value 3, Display 3), etc.</p>
                    </div>
                    
                    <div class="text-center">
                        <button id="generate-variation-csv-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                    </div>
                </div>
            </div>
            
            <!-- Category Assignment Section -->
            <div id="category-assignment-section" class="hidden">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 text-center">Category Assignments CSV Template</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column A: Product ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column B: Category ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column C: Primary Category ID</span>
                                <span class="block text-xs text-slate-500">Optional - Set to "TRUE" to mark as primary</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="generate-category-assignment-csv-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                    </div>
                </div>
            </div>
            
            <!-- Category Position Section -->
            <div id="category-position-section" class="hidden">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 text-center">Category Position CSV Template</h3>
                    
                    <!-- Sorting Selection -->
                    <div class="mb-6 p-4 bg-white rounded-lg border border-slate-300">
                        <label for="sorting-type-select" class="block text-sm font-medium text-slate-700 mb-2">Sorting Type <span class="text-red-500">*</span></label>
                        <select id="sorting-type-select" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                            <option value="">-- Select Sorting Type --</option>
                            <option value="auto">auto</option>
                            <option value="top">top</option>
                            <option value="bottom">bottom</option>
                            <option value="none">none</option>
                        </select>
                        <p class="text-xs text-slate-500 mt-1">Choose how products should be positioned within categories</p>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column A: Category ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column B: Product ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="generate-category-position-csv-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                    </div>
                </div>
            </div>
            
            <!-- Image Mapping Section -->
            <div id="image-mapping-section" class="hidden">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 text-center">Image Mappings CSV Template</h3>
                    
                    <!-- Image Mapping Type Selection -->
                    <div class="mb-6 p-4 bg-white rounded-lg border border-slate-300">
                        <label class="block text-sm font-medium text-slate-700 mb-3">Image Mapping Type <span class="text-red-500">*</span></label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">
                                <input type="radio" name="imageMappingType" value="flat" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                <div>
                                    <span class="font-medium text-slate-800">Flat Image Mapping</span>
                                    <p class="text-xs text-slate-600 mt-1">Standard product images with different view types (large, medium, small, hi-res)</p>
                                </div>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors">
                                <input type="radio" name="imageMappingType" value="variation" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                <div>
                                    <span class="font-medium text-slate-800">Variation Image Mapping</span>
                                    <p class="text-xs text-slate-600 mt-1">Products with variations (colors, sizes) that need different images per variation</p>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Flat Image Mapping Content -->
                    <div id="flat-image-content" class="hidden">
                        <div class="mb-6">
                            <h4 class="font-semibold text-slate-800 mb-2">CSV Structure - Flat Mapping:</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-white p-3 rounded-lg border border-slate-300">
                                    <span class="font-medium text-slate-700">Column A: Product ID</span>
                                    <span class="block text-xs text-slate-500">Required</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-slate-300">
                                    <span class="font-medium text-slate-700">Column B: Large Image Path</span>
                                    <span class="block text-xs text-slate-500">Optional</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-slate-300">
                                    <span class="font-medium text-slate-700">Column C: Medium Image Path</span>
                                    <span class="block text-xs text-slate-500">Optional</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-slate-300">
                                    <span class="font-medium text-slate-700">Column D: Small Image Path</span>
                                    <span class="block text-xs text-slate-500">Optional</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-slate-300">
                                    <span class="font-medium text-slate-700">Column E: Hi-res Image Path</span>
                                    <span class="block text-xs text-slate-500">Optional</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Variation Image Mapping Content -->
                    <div id="variation-image-content" class="hidden">
                        <div class="mb-6">
                            <h4 class="font-semibold text-slate-800 mb-2">CSV Structure - Variation Mapping:</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                                <div class="bg-white p-3 rounded-lg border border-slate-300">
                                    <span class="font-medium text-slate-700">Column A: Product ID</span>
                                    <span class="block text-xs text-slate-500">Required</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-slate-300">
                                    <span class="font-medium text-slate-700">Column B: Variation Value</span>
                                    <span class="block text-xs text-slate-500">BL, YL, WH, etc.</span>
                                </div>
                                <div class="bg-white p-3 rounded-lg border border-slate-300 md:col-span-1 col-span-2">
                                    <span class="font-medium text-slate-700">Columns C-F: Image Paths</span>
                                    <span class="block text-xs text-slate-500">Up to 4 images per variation</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="generate-image-mapping-csv-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                    </div>
                </div>
            </div>
            
            <!-- Variation Group Section -->
            <div id="variation-group-section" class="hidden">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 text-center">Variation Groups CSV Template</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column A: Master Product ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column B: Variation Group ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column C: Grouping Variation Attribute</span>
                                <span class="block text-xs text-slate-500">e.g., color, size</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column D: Grouping Variation Attribute Value</span>
                                <span class="block text-xs text-slate-500">e.g., JJ80XX, Large</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column E: Online Flag</span>
                                <span class="block text-xs text-slate-500">true/false</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column F: Available Flag</span>
                                <span class="block text-xs text-slate-500">true/false</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300 md:col-span-1 col-span-2">
                                <span class="font-medium text-slate-700">Column G: Searchable Flag</span>
                                <span class="block text-xs text-slate-500">true/false</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="generate-variation-group-csv-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                    </div>
                </div>
            </div>
            
            <!-- Prices Section -->
            <div id="prices-section" class="hidden">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 text-center">Prices CSV Template</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column A: Product ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column B: Price</span>
                                <span class="block text-xs text-slate-500">Required (base price, qty 1)</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column C: Online From</span>
                                <span class="block text-xs text-slate-500">Optional (date)</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column D: Online To</span>
                                <span class="block text-xs text-slate-500">Optional (date)</span>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-300 md:col-span-2">
                                <span class="font-medium text-blue-900">Columns E-V: Quantity Pricing</span>
                                <span class="block text-xs text-blue-700 mt-1">Optional quantity tiers (Quantity 2, Price 2, Quantity 3, Price 3, ... Quantity 10, Price 10)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="generate-prices-csv-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Section -->
            <div id="inventory-section" class="hidden">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-900 text-center">Inventory CSV Template</h3>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-slate-800 mb-2">CSV Structure:</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column A: Product ID</span>
                                <span class="block text-xs text-slate-500">Required</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column B: Allocation</span>
                                <span class="block text-xs text-slate-500">Optional (can be blank for perpetual/preorder)</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column C: Perpetual</span>
                                <span class="block text-xs text-slate-500">True/False</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column D: Pre-order / Backorder</span>
                                <span class="block text-xs text-slate-500">preorder, backorder, or none</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column E: Pre-order/Backorder Allocation</span>
                                <span class="block text-xs text-slate-500">Number (0 if none)</span>
                            </div>
                            <div class="bg-white p-3 rounded-lg border border-slate-300">
                                <span class="font-medium text-slate-700">Column F: Pre-order / Backorder In-Stock Date</span>
                                <span class="block text-xs text-slate-500">Optional (multiple date formats supported)</span>
                            </div>
                        </div>

                    </div>
                    
                    <div class="text-center">
                        <button id="generate-inventory-csv-btn" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all transform hover:scale-105 shadow-lg">Generate CSV Template</button>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Step 3: Convert CSV to XML -->
        <section id="conversion-section" class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-slate-200 hidden fade-in">
            <h2 class="text-2xl font-bold mb-6 text-slate-900">Step 3. Convert Populated CSV to XML</h2>
            
            <!-- Catalog ID Input (for applicable object types) -->
            <div id="step3-catalog-id-section" class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                <label for="step3-catalog-id-input" class="block text-sm font-medium text-slate-700 mb-2">Catalog ID <span class="text-red-500">*</span></label>
                <input type="text" id="step3-catalog-id-input" placeholder="e.g., 'master-catalog' or 'storefront-catalog'" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
            </div>
            
            <!-- Prices Fields (Price Book ID and Currency) -->
            <div id="step3-prices-section" class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                <h4 class="font-semibold text-slate-700 mb-3">Prices Configuration</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="step3-pricebook-id" class="block text-sm font-medium text-slate-700 mb-2">Price Book ID <span class="text-red-500">*</span></label>
                        <input type="text" id="step3-pricebook-id" placeholder="e.g., 'usd-list-prices'" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
                    </div>
                    <div>
                        <label for="step3-currency" class="block text-sm font-medium text-slate-700 mb-2">Currency <span class="text-red-500">*</span></label>
                        <input type="text" id="step3-currency" placeholder="e.g., 'USD'" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Field (Inventory List ID) -->
            <div id="step3-inventory-section" class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200 hidden">
                <label for="step3-inventory-list-id" class="block text-sm font-medium text-slate-700 mb-2">Inventory List ID <span class="text-red-500">*</span></label>
                <input type="text" id="step3-inventory-list-id" placeholder="e.g., 'inventory-TEST'" class="w-full px-4 py-2 bg-white border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                <p class="text-xs text-slate-500 mt-1">Required for XML generation</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Upload CSV File</label>
                    <div id="file-drop-zone" class="file-drop-zone border-2 border-dashed border-slate-300 rounded-lg p-8 text-center cursor-pointer">
                        <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                        <p id="drop-zone-text" class="text-slate-500">Drag & drop your CSV file here, or click to select a file.</p>
                    </div>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col justify-center items-center">
                    <p id="conversion-status" class="text-slate-600 mb-4 text-center">Ready to convert.</p>
                    <button id="generate-xml-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:bg-slate-400 disabled:cursor-not-allowed transition-all shadow-lg">Generate XML File</button>
                </div>
            </div>
        </section>

        <footer class="text-center mt-8 md:mt-12 text-sm text-slate-500">
            <p>For use with Salesforce B2C Commerce data imports.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const objectTypeRadios = document.querySelectorAll('input[name="objectType"]');
            const attributeSection = document.getElementById('attribute-section');
            const conversionSection = document.getElementById('conversion-section');
            const productAttributesDescription = document.getElementById('product-attributes-help');
            const categoryAttributesHelp = document.getElementById('category-attributes-help');
            const productRecommendationHelp = document.getElementById('product-recommendation-help');
            const variationMappingHelp = document.getElementById('variation-mapping-help');
            const categoryAssignmentHelp = document.getElementById('category-assignment-help');
            const categoryPositionHelp = document.getElementById('category-position-help');
            const imageMappingHelp = document.getElementById('image-mapping-help');
            const variationGroupHelp = document.getElementById('variation-group-help');
            const pricesHelp = document.getElementById('prices-help');
            const inventoryHelp = document.getElementById('inventory-help');
            const contentAssetHelp = document.getElementById('content-asset-help');
            const libraryFolderHelp = document.getElementById('library-folder-help');
            const staticCustomerGroupHelp = document.getElementById('static-customer-group-help');
            const productSetsHelp = document.getElementById('product-sets-help');
            const customerHelp = document.getElementById('customer-help');
            const localeSection = document.getElementById('locale-section');
            const localeSectionMoved = document.getElementById('locale-section-moved');
            const localeCheckbox = document.getElementById('locale-checkbox');
            const localeDropdownContainer = document.getElementById('locale-dropdown-container');
            const siteSection = document.getElementById('site-section');
            const siteSectionMoved = document.getElementById('site-section-moved');
            const siteCheckbox = document.getElementById('site-checkbox');
            const siteInputContainer = document.getElementById('site-input-container');
            const siteIdInput = document.getElementById('site-id-input');
            const siteCheckboxMoved = document.getElementById('site-checkbox-moved');
            const siteInputContainerMoved = document.getElementById('site-input-container-moved');
            const siteIdInputMoved = document.getElementById('site-id-input-moved');
            const attributesSection = document.getElementById('attributes-section');
            const customAttributesSection = document.getElementById('custom-attributes-section');
            const variationMappingSection = document.getElementById('variation-mapping-section');
            const productRecommendationSection = document.getElementById('product-recommendation-section');
            const categoryAssignmentSection = document.getElementById('category-assignment-section');
            const categoryPositionSection = document.getElementById('category-position-section');
            const imageMappingSection = document.getElementById('image-mapping-section');
            const localeSelect = document.getElementById('locale-select');
            const standardAttributesContainer = document.getElementById('standard-attributes');
            const customAttributesTableBody = document.getElementById('custom-attributes-table-body');
            const addRowBtn = document.getElementById('add-row-btn');
            const clearTableBtn = document.getElementById('clear-table-btn');
            const applyCustomAttributesBtn = document.getElementById('apply-custom-attributes-btn');
            const selectedAttributesList = document.getElementById('selected-attributes-list');
            const noAttributesMessage = document.getElementById('no-attributes-message');
            const generateSheetBtn = document.getElementById('generate-sheet-btn');
            const generateVariationCsvBtn = document.getElementById('generate-variation-csv-btn');
            const generateProductRecommendationCsvBtn = document.getElementById('generate-product-recommendation-csv-btn');
            const generateCategoryAssignmentCsvBtn = document.getElementById('generate-category-assignment-csv-btn');
            const generateCategoryPositionCsvBtn = document.getElementById('generate-category-position-csv-btn');
            const generateImageMappingCsvBtn = document.getElementById('generate-image-mapping-csv-btn');
            const step3CatalogIdSection = document.getElementById('step3-catalog-id-section');
            const step3CatalogIdInput = document.getElementById('step3-catalog-id-input');
            const step3PricesSection = document.getElementById('step3-prices-section');
            const step3PricebookIdInput = document.getElementById('step3-pricebook-id');
            const step3CurrencyInput = document.getElementById('step3-currency');
            const step3InventorySection = document.getElementById('step3-inventory-section');
            const step3InventoryListIdInput = document.getElementById('step3-inventory-list-id');
            const recommendationCatalogIdInput = document.getElementById('recommendation-catalog-id');
            const variationMappingCatalogIdInput = document.getElementById('variation-mapping-catalog-id');
            const categoryAssignmentCatalogIdInput = document.getElementById('category-assignment-catalog-id');
            const positionCatalogIdInput = document.getElementById('position-catalog-id');
            const sortingTypeSelect = document.getElementById('sorting-type-select');
            const imageMappingTypeRadios = document.querySelectorAll('input[name="imageMappingType"]');
            const flatImageContent = document.getElementById('flat-image-content');
            const variationImageContent = document.getElementById('variation-image-content');
            const imageMappingCatalogIdInput = document.getElementById('image-mapping-catalog-id');
            const variationGroupSection = document.getElementById('variation-group-section');
            const generateVariationGroupCsvBtn = document.getElementById('generate-variation-group-csv-btn');
            const variationGroupCatalogIdInput = document.getElementById('variation-group-catalog-id');
            const pricesSection = document.getElementById('prices-section');
            const generatePricesCsvBtn = document.getElementById('generate-prices-csv-btn');
            const pricesPricebookIdInput = document.getElementById('prices-pricebook-id');
            const pricesCurrencyInput = document.getElementById('prices-currency');
            const inventorySection = document.getElementById('inventory-section');
            const generateInventoryCsvBtn = document.getElementById('generate-inventory-csv-btn');
            const inventoryListIdInput = document.getElementById('inventory-list-id');
            const contentAssetSection = document.getElementById('content-asset-section');
            const contentLibraryIdInput = document.getElementById('content-library-id');
            const contentLocaleSelect = document.getElementById('content-locale-select');
            const libraryFolderSection = document.getElementById('library-folder-section');
            const folderLibraryIdInput = document.getElementById('folder-library-id');
            const folderLocaleSelect = document.getElementById('folder-locale-select');
            const generateLibraryFolderCsvBtn = document.getElementById('generate-library-folder-csv-btn');
            const staticCustomerGroupSection = document.getElementById('static-customer-group-section');
            const staticGroupIdInput = document.getElementById('static-group-id');
            const generateStaticCustomerGroupCsvBtn = document.getElementById('generate-static-customer-group-csv-btn');
            const productSetsSection = document.getElementById('product-sets-section');
            const productSetsCatalogIdInput = document.getElementById('product-sets-catalog-id');
            const productSetsStandardAttributes = document.getElementById('product-sets-standard-attributes');
            const productSetsCustomAttributesTable = document.getElementById('product-sets-custom-attributes-table');
            const addProductSetsRowBtn = document.getElementById('add-product-sets-row-btn');
            const clearProductSetsTableBtn = document.getElementById('clear-product-sets-table-btn');
            const applyProductSetsAttributesBtn = document.getElementById('apply-product-sets-attributes-btn');
            const generateProductSetsCsvBtn = document.getElementById('generate-product-sets-csv-btn');
            const productSetsSelectedList = document.getElementById('product-sets-selected-list');
            const productSetsNoAttributes = document.getElementById('product-sets-no-attributes');
            const defaultColumnHeader = document.getElementById('default-column-header');
            const standardAttributesHeader = document.getElementById('standard-attributes-header');
            const customAttributesHeader = document.getElementById('custom-attributes-header');
            const mainCatalogIdInput = document.getElementById('main-catalog-id-input');
            const catalogIdInput = document.getElementById('catalog-id-input');
            const fileDropZone = document.getElementById('file-drop-zone');
            const csvFileInput = document.getElementById('csv-file-input');
            const dropZoneText = document.getElementById('drop-zone-text');
            const conversionStatus = document.getElementById('conversion-status');
            const generateXmlBtn = document.getElementById('generate-xml-btn');
            
            // --- Attribute Data ---
            const attributeData = {};
            
            // Product attributes with their types
            attributeData.Product = {
                'EAN': 'String',
                'UPC': 'String', 
                'UUID': 'String',
                'brand': 'String',
                'creationDate': 'Date+Time',
                'facebookEnabled': 'Boolean',
                'image': 'Image',
                'lastModified': 'Date+Time',
                'localizedTaxClassID': 'String',
                'longDescription': 'HTML',
                'manufacturerName': 'String',
                'manufacturerSKU': 'String',
                'minOrderQuantity': 'Quantity',
                'onlineFlag': 'Boolean',
                'onlineFrom': 'Date+Time',
                'onlineTo': 'Date+Time',
                'pageDescription': 'String',
                'pageKeywords': 'String',
                'pageTitle': 'String',
                'pageURL': 'String',
                'pinterestEnabled': 'Boolean',
                'searchPlacement': 'Enum of Integers',
                'searchRank': 'Enum of Integers',
                'searchableFlag': 'Boolean',
                'searchableIfUnavailableFlag': 'Boolean',
                'shortDescription': 'HTML',
                'siteMapChangeFrequency': 'Enum of Strings',
                'siteMapIncludedFlag': 'Boolean',
                'siteMapPriority': 'Number',
                'stepQuantity': 'Quantity',
                'storeForcePriceFlag': 'Boolean',
                'storeNonDiscountableFlag': 'Boolean',
                'storeNonInventoryFlag': 'Boolean',
                'storeNonRevenueFlag': 'Boolean',
                'storeReceiptName': 'String',
                'storeTaxClass': 'String',
                'taxClassID': 'String',
                'template': 'String',
                'thumbnail': 'Image',
                'unit': 'String',
                'unitMeasure': 'String',
                'unitQuantity': 'Quantity',
                'displayName': 'String'
            };
            
            attributeData.Category = {
                'UUID': 'String',
                'alternativeUrl': 'HTML',
                'catBannerID': 'String',
                'creationDate': 'Date+Time',
                'customCSSFile': 'Image',
                'description': 'String',
                'displayMode': 'Enum of Integers',
                'displayName': 'String',
                'enableCompare': 'Boolean',
                'featuredSortingRule': 'String',
                'headerMenuBanner': 'HTML',
                'headerMenuOrientation': 'Enum of Strings',
                'image': 'Image',
                'lastModified': 'Date+Time',
                'onlineFlag': 'Boolean',
                'onlineFrom': 'Date+Time',
                'onlineTo': 'Date+Time',
                'pageDescription': 'String',
                'pageKeywords': 'String',
                'pageTitle': 'String',
                'pageURL': 'String',
                'searchPlacement': 'Enum of Integers',
                'searchRank': 'Enum of Integers',
                'showInMenu': 'Boolean',
                'siteMapChangeFrequency': 'Enum of Strings',
                'siteMapIncludedFlag': 'Boolean',
                'siteMapPriority': 'Number',
                'sizeChartID': 'String',
                'slotBannerHtml': 'HTML',
                'slotBannerImage': 'Image',
                'template': 'String',
                'thumbnail': 'Image'
            };
            
            attributeData.VariationMapping = {
                'variantProductID': 'String'
            };
            
            attributeData.CategoryAssignment = {
                'categoryID': 'String',
                'classificationCategoryID': 'String', 
                'primaryCategoryID': 'String'
            };
            
            attributeData.ProductRecommendation = {
                'recommendationType': 'String',
                'targetID': 'String',
                'sourceID': 'String'
            };
            
            attributeData.CategoryPosition = {
                'categoryID': 'String',
                'productID': 'String'
            };
            
            attributeData.ImageMapping = {
                'productID': 'String',
                'viewType': 'String',
                'imagePath': 'String',
                'variationValue': 'String',
                'imagePath1': 'String',
                'imagePath2': 'String',
                'imagePath3': 'String',
                'imagePath4': 'String'
            };
            
            attributeData.VariationGroup = {
                'masterProductId': 'String',
                'variationGroupId': 'String',
                'groupingVariationAttribute': 'String',
                'groupingVariationAttributeValue': 'String',
                'onlineFlag': 'Boolean',
                'availableFlag': 'Boolean',
                'searchableFlag': 'Boolean'
            };
            
            attributeData.Prices = {
                'productId': 'String',
                'price': 'Number',
                'onlineFrom': 'Date+Time',
                'onlineTo': 'Date+Time'
            };
            
            attributeData.Inventory = {
                'productId': 'String',
                'allocation': 'Number',
                'perpetual': 'Boolean',
                'preorderBackorder': 'String',
                'preorderBackorderAllocation': 'Number'
            };
            
            attributeData.ContentAsset = {
                'ID': 'String',
                'UUID': 'String',
                'Year': 'String',
                'aspectType': 'String',
                'body': 'HTML',
                'config': 'Text',
                'creationDate': 'Date+Time',
                'customCSSFile': 'Image',
                'data': 'Text',
                'description': 'String',
                'folder': 'String',
                'lastModified': 'Date+Time',
                'name': 'String',
                'onlineFlag': 'Boolean',
                'pageDescription': 'String',
                'pageKeywords': 'String',
                'pageTitle': 'String',
                'pageURL': 'String',
                'searchWords': 'String',
                'searchableFlag': 'Boolean',
                'siteMapChangeFrequency': 'Enum of Strings',
                'siteMapIncluded': 'Enum of Integers',
                'siteMapPriority': 'Number',
                'template': 'String',
                'type': 'String',
                'visibilityMode': 'Enum of Integers'
            };
            
            attributeData.Customer = {
                'UUID': 'String',
                'birthday': 'Date',
                'companyName': 'String',
                'creationDate': 'Date+Time',
                'customerNo': 'String',
                'email': 'Email',
                'familyStatus': 'Enum of Strings',
                'fax': 'String',
                'firstName': 'String',
                'gender': 'Enum of Integers',
                'isPro': 'Boolean',
                'jobTitle': 'String',
                'lastLoginTime': 'Date+Time',
                'lastModified': 'Date+Time',
                'lastName': 'String',
                'lastVisitTime': 'Date+Time',
                'nextBirthday': 'Date',
                'phoneBusiness': 'String',
                'phoneHome': 'String',
                'phoneMobile': 'String',
                'preferredLocale': 'String',
                'salutation': 'String',
                'secondName': 'String',
                'suffix': 'String',
                'taxID': 'String',
                'taxIDType': 'Enum of Strings',
                'title': 'String'
            };
            
            
            
            // --- State ---
            let selectedAttributes = new Set();
            let currentObjectType = null;
            let currentStandardAttributes = {};
            let customAttributeTypes = {}; // Store custom attribute types
            let customAttributeFlags = {}; // Store custom attribute flags (localizable, siteSpecific)
            let parsedCsvData = null;
            let productSetsCustomAttributes = []; // Store custom attributes for Product Sets
            let productSetsSelectedAttributes = new Set(); // Store selected standard attributes for Product Sets
            
            // Site-specific attributes for Products
            const siteSpecificAttributes = [
                'displayName',
                'facebookEnabled',
                'onlineFlag',
                'onlineFrom',
                'onlineTo',
                'pinterestEnabled',
                'searchPlacement',
                'searchRank',
                'searchableFlag',
                'searchableIfUnavailableFlag',
                'siteMapChangeFrequency',
                'siteMapIncludedFlag',
                'siteMapPriority'
            ];
            
            // Localizable attributes for Products
            const localizableProductAttributes = [
                'longDescription',
                'pageDescription',
                'pageKeywords',
                'pageTitle',
                'pageURL',
                'shortDescription',
                'storeReceiptName'
            ];

            // --- Functions ---
            const getAttributeType = (attribute) => {
                return currentStandardAttributes[attribute] || customAttributeTypes[attribute] || 'String';
            };

            const getTypeColorClass = (type) => {
                const typeColors = {
                    'String': 'bg-blue-100 text-blue-800',
                    'Text': 'bg-blue-100 text-blue-800',
                    'Boolean': 'bg-green-100 text-green-800', 
                    'Date': 'bg-purple-100 text-purple-800',
                    'Date+Time': 'bg-purple-100 text-purple-800',
                    'Image': 'bg-orange-100 text-orange-800',
                    'HTML': 'bg-red-100 text-red-800',
                    'Integer': 'bg-indigo-100 text-indigo-800',
                    'Number': 'bg-indigo-100 text-indigo-800',
                    'Quantity': 'bg-yellow-100 text-yellow-800',
                    'Email': 'bg-cyan-100 text-cyan-800',
                    'Password': 'bg-gray-100 text-gray-800',
                    'Set of Strings': 'bg-teal-100 text-teal-800',
                    'Set of Integers': 'bg-pink-100 text-pink-800',
                    'Set of Numbers': 'bg-emerald-100 text-emerald-800',
                    'Enum of Integers': 'bg-pink-100 text-pink-800',
                    'Enum of Strings': 'bg-teal-100 text-teal-800'
                };
                return typeColors[type] || 'bg-gray-100 text-gray-800';
            };

            const renderStandardAttributes = () => {
                standardAttributesContainer.innerHTML = '';
                const attributeKeys = Object.keys(currentStandardAttributes).sort();
                attributeKeys.forEach(attr => {
                    const isChecked = selectedAttributes.has(attr);
                    const attributeType = currentStandardAttributes[attr];
                    const typeColorClass = getTypeColorClass(attributeType);
                    const isSiteSpecific = siteSpecificAttributes.includes(attr);
                    const isLocalizable = localizableProductAttributes.includes(attr);
                    
                    // Globe icon for site-specific (blue)
                    const globeIcon = isSiteSpecific ? '<svg class="w-3 h-3 ml-1 inline text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"/></svg>' : '';
                    
                    // Language icon for localizable (purple)
                    const langIcon = isLocalizable ? '<svg class="w-3 h-3 ml-1 inline text-purple-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/></svg>' : '';
                    
                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'rounded-md', 'hover:bg-slate-100', 'transition-colors');
                    div.innerHTML = `
                        <div class="flex items-center">
                            <input type="checkbox" id="attr-${attr}" value="${attr}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}>
                            <label for="attr-${attr}" class="ml-3 text-sm text-slate-700 flex items-center">${attr}${globeIcon}${langIcon}</label>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full font-medium ${typeColorClass}">${attributeType}</span>
                    `;
                    standardAttributesContainer.appendChild(div);
                });
            };

            const renderSelectedAttributes = () => {
                const attributesToRemove = Array.from(selectedAttributesList.children).filter(child => child.dataset.attribute);
                attributesToRemove.forEach(child => child.remove());
                const sortedAttributes = Array.from(selectedAttributes).sort();
                noAttributesMessage.style.display = sortedAttributes.length === 0 ? 'block' : 'none';
                generateSheetBtn.disabled = sortedAttributes.length === 0;
                sortedAttributes.forEach(attr => {
                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'justify-between', 'bg-white', 'p-3', 'rounded-lg', 'shadow-sm', 'border', 'border-slate-200', 'fade-in');
                    div.dataset.attribute = attr;
                    
                    // Check if this is a custom attribute with flags
                    const attrFlags = customAttributeFlags[attr] || {};
                    const isCustom = !currentStandardAttributes[attr];
                    
                    // Add icons for localizable or site-specific custom attributes
                    let icons = '';
                    if (isCustom && attrFlags.localizable) {
                        icons += '<svg class="w-3 h-3 ml-1 inline text-purple-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/></svg>';
                    }
                    if (isCustom && attrFlags.siteSpecific) {
                        icons += '<svg class="w-3 h-3 ml-1 inline text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"/></svg>';
                    }
                    
                    div.innerHTML = `<span class="font-medium text-slate-800">${attr}${icons}</span><button data-attr-remove="${attr}" class="text-red-500 hover:text-red-700 font-bold text-xl leading-none">&times;</button>`;
                    selectedAttributesList.appendChild(div);
                });
            };
            
            const handleAttributeToggle = (attribute, isSelected) => {
                isSelected ? selectedAttributes.add(attribute) : selectedAttributes.delete(attribute);
                renderSelectedAttributes();
            };

            const addCustomAttribute = () => {
                const customAttr = customAttributeInput.value.trim();
                const customType = customAttributeType.value || 'String'; // Default to String if not specified
                
                if (customAttr && !selectedAttributes.has(customAttr) && !Object.keys(currentStandardAttributes).includes(customAttr)) {
                    selectedAttributes.add(customAttr);
                    // Only store the type if it's not the default String type
                    if (customType !== 'String') {
                        customAttributeTypes[customAttr] = customType;
                    }
                    customAttributeInput.value = '';
                    customAttributeType.value = ''; // Reset to default (String)
                    renderSelectedAttributes();
                    renderStandardAttributes();
                } else if (customAttr) {
                    const existingEl = Array.from(selectedAttributesList.children).find(child => child.dataset.attribute === customAttr);
                    if (existingEl) { existingEl.classList.add('bg-yellow-200'); setTimeout(() => existingEl.classList.remove('bg-yellow-200'), 500); }
                }
                customAttributeInput.focus();
            };

            const createTypeSelect = (selectedValue = '') => {
                const options = [
                    { value: '', label: '-- Default (String) --' },
                    { value: 'String', label: 'String' },
                    { value: 'Text', label: 'Text' },
                    { value: 'HTML', label: 'HTML' },
                    { value: 'Integer', label: 'Integer' },
                    { value: 'Number', label: 'Number' },
                    { value: 'Boolean', label: 'Boolean' },
                    { value: 'Date', label: 'Date' },
                    { value: 'Date+Time', label: 'Date+Time' },
                    { value: 'Image', label: 'Image' },
                    { value: 'Email', label: 'Email' },
                    { value: 'Password', label: 'Password' },
                    { value: 'Set of Strings', label: 'Set of Strings' },
                    { value: 'Set of Integers', label: 'Set of Integers' },
                    { value: 'Set of Numbers', label: 'Set of Numbers' },
                    { value: 'Enum of Strings', label: 'Enum of Strings' },
                    { value: 'Enum of Integers', label: 'Enum of Integers' }
                ];
                
                const select = document.createElement('select');
                select.className = 'w-full px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500';
                
                options.forEach(option => {
                    const optionEl = document.createElement('option');
                    optionEl.value = option.value;
                    optionEl.textContent = option.label;
                    if (option.value === selectedValue) {
                        optionEl.selected = true;
                    }
                    select.appendChild(optionEl);
                });
                
                return select;
            };

            const addTableRow = (name = '', type = '', isLocalizable = false, isSiteSpecific = false) => {
                const tbody = customAttributesTableBody;
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                
                const rowId = `attr-row-${Date.now()}-${Math.random()}`;
                
                row.innerHTML = `
                    <td class="px-4 py-2">
                        <input type="text" class="custom-attr-name w-full px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" 
                               placeholder="e.g., isOutlet" value="${name}">
                    </td>
                    <td class="px-4 py-2">
                        <div class="custom-attr-type-container"></div>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <div class="relative inline-block">
                            <input type="checkbox" class="custom-attr-localizable h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500" 
                                   ${isLocalizable ? 'checked' : ''} ${isSiteSpecific ? 'disabled' : ''} 
                                   data-row-id="${rowId}" title="${isSiteSpecific ? 'Cannot be both localizable and site-specific' : 'Mark as localizable'}">
                        </div>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <div class="relative inline-block">
                            <input type="checkbox" class="custom-attr-site-specific h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                                   ${isSiteSpecific ? 'checked' : ''} ${isLocalizable ? 'disabled' : ''} 
                                   data-row-id="${rowId}" title="${isLocalizable ? 'Cannot be both localizable and site-specific' : 'Mark as site-specific'}">
                        </div>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button class="remove-row-btn text-red-500 hover:text-red-700 font-bold text-lg leading-none" title="Remove row">
                            √ó
                        </button>
                    </td>
                `;
                
                // Add the type select to the container
                const typeContainer = row.querySelector('.custom-attr-type-container');
                typeContainer.appendChild(createTypeSelect(type));
                
                tbody.appendChild(row);
                
                // Add mutual exclusivity logic for checkboxes
                const localizableCheckbox = row.querySelector('.custom-attr-localizable');
                const siteSpecificCheckbox = row.querySelector('.custom-attr-site-specific');
                
                localizableCheckbox.addEventListener('change', () => {
                    if (localizableCheckbox.checked) {
                        siteSpecificCheckbox.disabled = true;
                        siteSpecificCheckbox.checked = false;
                        siteSpecificCheckbox.title = 'Cannot be both localizable and site-specific';
                    } else {
                        siteSpecificCheckbox.disabled = false;
                        siteSpecificCheckbox.title = 'Mark as site-specific';
                    }
                });
                
                siteSpecificCheckbox.addEventListener('change', () => {
                    if (siteSpecificCheckbox.checked) {
                        localizableCheckbox.disabled = true;
                        localizableCheckbox.checked = false;
                        localizableCheckbox.title = 'Cannot be both localizable and site-specific';
                    } else {
                        localizableCheckbox.disabled = false;
                        localizableCheckbox.title = 'Mark as localizable';
                    }
                });
                
                // Focus on the name input
                const nameInput = row.querySelector('.custom-attr-name');
                nameInput.focus();
                
                return row;
            };

            const applyCustomAttributes = () => {
                const rows = customAttributesTableBody.querySelectorAll('tr');
                let addedCount = 0;
                const duplicates = [];
                
                rows.forEach(row => {
                    const nameInput = row.querySelector('.custom-attr-name');
                    const typeSelect = row.querySelector('select');
                    const localizableCheckbox = row.querySelector('.custom-attr-localizable');
                    const siteSpecificCheckbox = row.querySelector('.custom-attr-site-specific');
                    
                    const name = nameInput.value.trim();
                    const type = typeSelect.value || 'String';
                    const isLocalizable = localizableCheckbox.checked;
                    const isSiteSpecific = siteSpecificCheckbox.checked;
                    
                    if (name && !selectedAttributes.has(name) && !Object.keys(currentStandardAttributes).includes(name)) {
                        selectedAttributes.add(name);
                        // Store the type if it's not the default String type
                        if (type !== 'String') {
                            customAttributeTypes[name] = type;
                        }
                        // Store localizable/site-specific flags if set
                        if (isLocalizable) {
                            if (!customAttributeFlags[name]) customAttributeFlags[name] = {};
                            customAttributeFlags[name].localizable = true;
                        }
                        if (isSiteSpecific) {
                            if (!customAttributeFlags[name]) customAttributeFlags[name] = {};
                            customAttributeFlags[name].siteSpecific = true;
                        }
                        addedCount++;
                        
                        // Clear the row after successful addition
                        nameInput.value = '';
                        typeSelect.value = '';
                        localizableCheckbox.checked = false;
                        siteSpecificCheckbox.checked = false;
                        siteSpecificCheckbox.disabled = false;
                        localizableCheckbox.disabled = false;
                    } else if (name) {
                        duplicates.push(name);
                        // Highlight the duplicate row
                        nameInput.classList.add('border-red-300', 'bg-red-50');
                        setTimeout(() => {
                            nameInput.classList.remove('border-red-300', 'bg-red-50');
                        }, 2000);
                    }
                });
                
                if (addedCount > 0) {
                    renderSelectedAttributes();
                    renderStandardAttributes();
                }
                
                // Show feedback
                if (duplicates.length > 0) {
                    console.warn(`Duplicate or standard attributes skipped: ${duplicates.join(', ')}`);
                }
            };

            const clearCustomAttributesTable = () => {
                customAttributesTableBody.innerHTML = '';
                addTableRow();
            };

            const downloadFile = (content, mimeType, filename) => {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const generateCSV = () => {
                if (selectedAttributes.size === 0 || !currentObjectType) return;
                const useLocale = localeCheckbox.checked;
                const selectedLocale = useLocale ? localeSelect.value : 'default';
                const headers = [`${currentObjectType}ID`, ...Array.from(selectedAttributes).sort()];
                const csvContent = headers.join(',');
                const localeString = selectedLocale !== 'default' ? `_${selectedLocale}` : '';
                downloadFile(csvContent, 'text/csv', `b2c_${currentObjectType.toLowerCase()}_import_template${localeString}.csv`);
            };

            const generateVariationMappingCSV = () => {
                // Generate headers: one row per variant
                const headers = ['Variation Product ID', 'Base Product ID', 'onlineFlag', 'searchableFlag', 'Variation Attribute ID 1', 'Variation Attribute Name 1', 'Variation Value 1', 'Variation Value Display 1'];
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_variation_mapping_template.csv');
            };

            const generateCategoryAssignmentCSV = () => {
                const headers = ['Product ID', 'Category ID', 'Primary Category ID'];
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_category_assignment_template.csv');
            };

            const generateProductRecommendationCSV = () => {
                const headers = ['Recommendation Type', 'Target ID', 'Source ID'];
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_product_recommendation_template.csv');
            };

            const generateCategoryPositionCSV = () => {
                const headers = ['Category ID', 'Product ID'];
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_category_position_template.csv');
            };

            const generateImageMappingCSV = () => {
                const selectedType = document.querySelector('input[name="imageMappingType"]:checked')?.value;
                
                if (selectedType === 'flat') {
                    const headers = ['Product ID', 'Large Image Path', 'Medium Image Path', 'Small Image Path', 'Hi-res Image Path'];
                    const csvContent = headers.join(',');
                    downloadFile(csvContent, 'text/csv', 'b2c_image_mapping_flat_template.csv');
                } else if (selectedType === 'variation') {
                    const headers = ['Product ID', 'Variation Value', 'Image Path 1', 'Image Path 2', 'Image Path 3', 'Image Path 4'];
                    const csvContent = headers.join(',');
                    downloadFile(csvContent, 'text/csv', 'b2c_image_mapping_variation_template.csv');
                } else {
                    alert('Please select an image mapping type first.');
                }
            };

            const generateVariationGroupCSV = () => {
                const headers = ['Master Product ID', 'Variation Group ID', 'Grouping Variation Attribute', 'Grouping Variation Attribute Value', 'Online Flag', 'Available Flag', 'Searchable Flag'];
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_variation_group_template.csv');
            };

            const generatePricesCSV = () => {
                const headers = ['Product ID', 'Price', 'Online From', 'Online To'];
                
                // Add quantity pricing columns (Quantity 2-10 and Price 2-10)
                for (let i = 2; i <= 10; i++) {
                    headers.push(`Quantity ${i}`);
                    headers.push(`Price ${i}`);
                }
                
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_prices_template.csv');
            };

            const generateInventoryCSV = () => {
                const headers = ['Product ID', 'Allocation', 'Perpetual', 'Pre-order / Backorder', 'Pre-order/Backorder Allocation', 'Pre-order / Backorder In-Stock Date'];
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_inventory_template.csv');
            };

            const generateLibraryFolderCSV = () => {
                const headers = ['ID', 'Display Name', 'Description', 'Parent'];
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_library_folders_template.csv');
            };

            const generateStaticCustomerGroupCSV = () => {
                const headers = ['Customer Number'];
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_static_customer_group_template.csv');
            };

            const generateProductSetsCSV = () => {
                // Base header - only Product Set ID
                const headers = ['Product Set ID'];
                
                // Add selected standard attribute headers
                const sortedStandardAttrs = Array.from(productSetsSelectedAttributes).sort();
                sortedStandardAttrs.forEach(attr => {
                    headers.push(attr);
                });
                
                // Add custom attribute headers after standard attributes
                productSetsCustomAttributes.forEach(attr => {
                    headers.push(attr.id);
                });
                
                // Add product ID columns after all attributes
                for (let i = 1; i <= 100; i++) {
                    headers.push(`Product ID ${i}`);
                }
                
                const csvContent = headers.join(',');
                downloadFile(csvContent, 'text/csv', 'b2c_product_sets_template.csv');
            };

            const addProductSetsTableRow = (name = '', type = '', isLocalizable = false, isSiteSpecific = false) => {
                const tbody = productSetsCustomAttributesTable;
                const row = document.createElement('tr');
                row.className = 'hover:bg-slate-50';
                
                const rowId = `ps-attr-row-${Date.now()}-${Math.random()}`;
                
                row.innerHTML = `
                    <td class="px-4 py-2">
                        <input type="text" class="product-sets-attr-name w-full px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500" 
                               placeholder="e.g., isOutlet" value="${name}">
                    </td>
                    <td class="px-4 py-2">
                        <select class="product-sets-attr-type w-full px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500">
                            <option value="">Select Type (defaults to String)</option>
                            <option value="String" ${type === 'String' ? 'selected' : ''}>String</option>
                            <option value="Text" ${type === 'Text' ? 'selected' : ''}>Text</option>
                            <option value="HTML" ${type === 'HTML' ? 'selected' : ''}>HTML</option>
                            <option value="Integer" ${type === 'Integer' ? 'selected' : ''}>Integer</option>
                            <option value="Number" ${type === 'Number' ? 'selected' : ''}>Number</option>
                            <option value="Boolean" ${type === 'Boolean' ? 'selected' : ''}>Boolean</option>
                            <option value="Date" ${type === 'Date' ? 'selected' : ''}>Date</option>
                            <option value="Date+Time" ${type === 'Date+Time' ? 'selected' : ''}>Date+Time</option>
                            <option value="Image" ${type === 'Image' ? 'selected' : ''}>Image</option>
                            <option value="Email" ${type === 'Email' ? 'selected' : ''}>Email</option>
                            <option value="Password" ${type === 'Password' ? 'selected' : ''}>Password</option>
                            <option value="Set of Strings" ${type === 'Set of Strings' ? 'selected' : ''}>Set of Strings</option>
                            <option value="Set of Integers" ${type === 'Set of Integers' ? 'selected' : ''}>Set of Integers</option>
                            <option value="Set of Numbers" ${type === 'Set of Numbers' ? 'selected' : ''}>Set of Numbers</option>
                            <option value="Enum of Strings" ${type === 'Enum of Strings' ? 'selected' : ''}>Enum of Strings</option>
                            <option value="Enum of Integers" ${type === 'Enum of Integers' ? 'selected' : ''}>Enum of Integers</option>
                        </select>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <div class="relative inline-block">
                            <input type="checkbox" class="product-sets-attr-localizable h-4 w-4 rounded border-gray-300 text-purple-600 focus:ring-purple-500" 
                                   ${isLocalizable ? 'checked' : ''} ${isSiteSpecific ? 'disabled' : ''} 
                                   data-row-id="${rowId}" title="${isSiteSpecific ? 'Cannot be both localizable and site-specific' : 'Mark as localizable'}">
                        </div>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <div class="relative inline-block">
                            <input type="checkbox" class="product-sets-attr-site-specific h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" 
                                   ${isSiteSpecific ? 'checked' : ''} ${isLocalizable ? 'disabled' : ''} 
                                   data-row-id="${rowId}" title="${isLocalizable ? 'Cannot be both localizable and site-specific' : 'Mark as site-specific'}">
                        </div>
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button class="remove-product-sets-row-btn text-red-600 hover:text-red-800 focus:outline-none" title="Remove row">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Add mutual exclusivity logic for checkboxes
                const localizableCheckbox = row.querySelector('.product-sets-attr-localizable');
                const siteSpecificCheckbox = row.querySelector('.product-sets-attr-site-specific');
                
                localizableCheckbox.addEventListener('change', () => {
                    if (localizableCheckbox.checked) {
                        siteSpecificCheckbox.disabled = true;
                        siteSpecificCheckbox.checked = false;
                        siteSpecificCheckbox.title = 'Cannot be both localizable and site-specific';
                    } else {
                        siteSpecificCheckbox.disabled = false;
                        siteSpecificCheckbox.title = 'Mark as site-specific';
                    }
                });
                
                siteSpecificCheckbox.addEventListener('change', () => {
                    if (siteSpecificCheckbox.checked) {
                        localizableCheckbox.disabled = true;
                        localizableCheckbox.checked = false;
                        localizableCheckbox.title = 'Cannot be both localizable and site-specific';
                    } else {
                        localizableCheckbox.disabled = false;
                        localizableCheckbox.title = 'Mark as localizable';
                    }
                });
            };

            const clearProductSetsCustomAttributesTable = () => {
                productSetsCustomAttributesTable.innerHTML = '';
                productSetsCustomAttributes = [];
                addProductSetsTableRow();
                renderProductSetsSelectedColumns();
            };

            const applyProductSetsCustomAttributes = () => {
                const rows = productSetsCustomAttributesTable.querySelectorAll('tr');
                const newAttributes = [];
                let addedCount = 0;
                const invalidNames = [];
                const duplicates = [];
                
                rows.forEach(row => {
                    const nameInput = row.querySelector('.product-sets-attr-name');
                    const typeSelect = row.querySelector('.product-sets-attr-type');
                    const localizableCheckbox = row.querySelector('.product-sets-attr-localizable');
                    const siteSpecificCheckbox = row.querySelector('.product-sets-attr-site-specific');
                    
                    if (nameInput && typeSelect) {
                        const name = nameInput.value.trim();
                        const type = typeSelect.value || 'String';
                        const isLocalizable = localizableCheckbox.checked;
                        const isSiteSpecific = siteSpecificCheckbox.checked;
                        
                        if (name) {
                            // Validate attribute name format
                            if (!/^[a-zA-Z][a-zA-Z0-9_]*$/.test(name)) {
                                invalidNames.push(name);
                                // Highlight the invalid row
                                nameInput.classList.add('border-red-300', 'bg-red-50');
                                setTimeout(() => {
                                    nameInput.classList.remove('border-red-300', 'bg-red-50');
                                }, 2000);
                                return;
                            }
                            
                            // Check for duplicates within the new batch
                            if (newAttributes.find(attr => attr.id === name)) {
                                duplicates.push(name);
                                // Highlight the duplicate row
                                nameInput.classList.add('border-red-300', 'bg-red-50');
                                setTimeout(() => {
                                    nameInput.classList.remove('border-red-300', 'bg-red-50');
                                }, 2000);
                                return;
                            }
                            
                            // Check if already exists in productSetsCustomAttributes
                            if (productSetsCustomAttributes.find(attr => attr.id === name)) {
                                duplicates.push(name);
                                // Highlight the duplicate row
                                nameInput.classList.add('border-red-300', 'bg-red-50');
                                setTimeout(() => {
                                    nameInput.classList.remove('border-red-300', 'bg-red-50');
                                }, 2000);
                                return;
                            }
                            
                            newAttributes.push({ id: name, type: type, localizable: isLocalizable, siteSpecific: isSiteSpecific });
                            addedCount++;
                            
                            // Clear the row after successful addition
                            nameInput.value = '';
                            typeSelect.value = '';
                            localizableCheckbox.checked = false;
                            siteSpecificCheckbox.checked = false;
                            siteSpecificCheckbox.disabled = false;
                            localizableCheckbox.disabled = false;
                        }
                    }
                });
                
                // Add new attributes to the list
                productSetsCustomAttributes.push(...newAttributes);
                
                // Update the selected columns list
                if (addedCount > 0) {
                    renderProductSetsSelectedColumns();
                }
                
                // Show feedback in console
                if (invalidNames.length > 0) {
                    console.warn(`Invalid attribute names skipped: ${invalidNames.join(', ')}`);
                }
                if (duplicates.length > 0) {
                    console.warn(`Duplicate attribute names skipped: ${duplicates.join(', ')}`);
                }
            };

            const renderProductSetsStandardAttributes = () => {
                productSetsStandardAttributes.innerHTML = '';
                const attributeKeys = Object.keys(attributeData.Product).sort();
                attributeKeys.forEach(attr => {
                    const isChecked = productSetsSelectedAttributes.has(attr);
                    const attributeType = attributeData.Product[attr];
                    const typeColorClass = getTypeColorClass(attributeType);
                    const isSiteSpecific = siteSpecificAttributes.includes(attr);
                    const isLocalizable = localizableProductAttributes.includes(attr);
                    
                    // Globe icon for site-specific (blue)
                    const globeIcon = isSiteSpecific ? '<svg class="w-3 h-3 ml-1 inline text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"/></svg>' : '';
                    
                    // Language icon for localizable (purple)
                    const langIcon = isLocalizable ? '<svg class="w-3 h-3 ml-1 inline text-purple-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/></svg>' : '';
                    
                    const div = document.createElement('div');
                    div.classList.add('flex', 'items-center', 'justify-between', 'p-2', 'rounded-md', 'hover:bg-slate-100', 'transition-colors');
                    div.innerHTML = `
                        <div class="flex items-center">
                            <input type="checkbox" id="ps-attr-${attr}" value="${attr}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}>
                            <label for="ps-attr-${attr}" class="ml-3 text-sm text-slate-700 flex items-center">${attr}${globeIcon}${langIcon}</label>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full font-medium ${typeColorClass}">${attributeType}</span>
                    `;
                    productSetsStandardAttributes.appendChild(div);
                });
            };

            const handleProductSetsAttributeToggle = (attribute, isSelected) => {
                isSelected ? productSetsSelectedAttributes.add(attribute) : productSetsSelectedAttributes.delete(attribute);
                renderProductSetsSelectedColumns();
            };

            const renderProductSetsSelectedColumns = () => {
                // Store default columns before clearing
                const defaultColumns = Array.from(productSetsSelectedList.querySelectorAll('[data-default="true"]')).map(col => col.cloneNode(true));
                
                // Clear the list
                productSetsSelectedList.innerHTML = '';
                
                // Re-add default columns
                defaultColumns.forEach(col => productSetsSelectedList.appendChild(col));
                
                // Add selected standard attributes
                const sortedStandardAttrs = Array.from(productSetsSelectedAttributes).sort();
                sortedStandardAttrs.forEach(attr => {
                    const attrType = attributeData.Product[attr];
                    const attrDiv = document.createElement('div');
                    attrDiv.className = 'flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-slate-200';
                    attrDiv.innerHTML = `
                        <div>
                            <span class="font-semibold text-slate-700">${escapeXml(attr)}</span>
                            <span class="block text-xs text-slate-500">${escapeXml(attrType)}</span>
                        </div>
                        <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded-full">Standard</span>
                    `;
                    productSetsSelectedList.appendChild(attrDiv);
                });
                
                // Add custom attributes with remove buttons
                productSetsCustomAttributes.forEach((attr, index) => {
                    const attrDiv = document.createElement('div');
                    attrDiv.className = 'flex items-center justify-between bg-white p-3 rounded-lg shadow-sm border border-slate-200';
                    attrDiv.dataset.customAttrIndex = index;
                    
                    // Add icons for localizable or site-specific custom attributes
                    let icons = '';
                    if (attr.localizable) {
                        icons += '<svg class="w-3 h-3 ml-1 inline text-purple-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 2a1 1 0 011 1v1h3a1 1 0 110 2H9.578a18.87 18.87 0 01-1.724 4.78c.29.354.596.696.914 1.026a1 1 0 11-1.44 1.389c-.188-.196-.373-.396-.554-.6a19.098 19.098 0 01-3.107 3.567 1 1 0 01-1.334-1.49 17.087 17.087 0 003.13-3.733 18.992 18.992 0 01-1.487-2.494 1 1 0 111.79-.89c.234.47.489.928.764 1.372.417-.934.752-1.913.997-2.927H3a1 1 0 110-2h3V3a1 1 0 011-1zm6 6a1 1 0 01.894.553l2.991 5.982a.869.869 0 01.02.037l.99 1.98a1 1 0 11-1.79.895L15.383 16h-4.764l-.724 1.447a1 1 0 11-1.788-.894l.99-1.98.019-.038 2.99-5.982A1 1 0 0113 8zm-1.382 6h2.764L13 11.236 11.618 14z" clip-rule="evenodd"/></svg>';
                    }
                    if (attr.siteSpecific) {
                        icons += '<svg class="w-3 h-3 ml-1 inline text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.523-1.943A5.977 5.977 0 0116 10c0 .34-.028.675-.083 1H15a2 2 0 00-2 2v2.197A5.973 5.973 0 0110 16v-2a2 2 0 00-2-2 2 2 0 01-2-2 2 2 0 00-1.668-1.973z" clip-rule="evenodd"/></svg>';
                    }
                    
                    attrDiv.innerHTML = `
                        <div class="flex-1">
                            <span class="font-semibold text-slate-700">${escapeXml(attr.id)}${icons}</span>
                            <span class="block text-xs text-slate-500">${escapeXml(attr.type)}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs font-medium text-indigo-600 bg-indigo-50 px-2 py-1 rounded-full">Custom</span>
                            <button data-ps-attr-remove="${index}" class="text-red-500 hover:text-red-700 font-bold text-xl leading-none">&times;</button>
                        </div>
                    `;
                    productSetsSelectedList.appendChild(attrDiv);
                });
                
                // Show/hide no attributes message
                if (productSetsSelectedAttributes.size === 0 && productSetsCustomAttributes.length === 0) {
                    productSetsNoAttributes.classList.remove('hidden');
                } else {
                    productSetsNoAttributes.classList.add('hidden');
                }
            };

            const handleFileSelect = (file) => {
                if (!file || !file.type.match('text/csv')) {
                    conversionStatus.textContent = 'Error: Please select a valid .csv file.';
                    conversionStatus.classList.add('text-red-500');
                    parsedCsvData = null;
                    return;
                }
                
                dropZoneText.textContent = `Selected: ${file.name}`;
                conversionStatus.textContent = 'File ready. Parsing...';
                conversionStatus.classList.remove('text-red-500');

                // Always read as ArrayBuffer to properly handle encoding
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const bytes = new Uint8Array(e.target.result);
                        
                        // Try to detect if it's UTF-8 or Windows-1252
                        let csvText;
                        if (isLikelyUTF8(bytes)) {
                            // Decode as UTF-8
                            const decoder = new TextDecoder('utf-8');
                            csvText = decoder.decode(bytes);
                        } else {
                            // Decode as Windows-1252
                            csvText = decodeWindows1252(bytes);
                        }
                        
                        parseCSVText(csvText);
                    } catch (error) {
                        conversionStatus.textContent = `File Read Error: ${error.message}`;
                        conversionStatus.classList.add('text-red-500');
                        parsedCsvData = null;
                    }
                };
                
                reader.onerror = () => {
                    conversionStatus.textContent = 'Error reading file.';
                    conversionStatus.classList.add('text-red-500');
                    parsedCsvData = null;
                };
                
                reader.readAsArrayBuffer(file);
            };
            
            // Simple heuristic to detect if bytes are likely UTF-8
            const isLikelyUTF8 = (bytes) => {
                // Check for UTF-8 BOM
                if (bytes.length >= 3 && bytes[0] === 0xEF && bytes[1] === 0xBB && bytes[2] === 0xBF) {
                    return true;
                }
                
                // Look for problematic Windows-1252 bytes in the 0x80-0x9F range
                // These are control characters in UTF-8 but printable in Windows-1252
                for (let i = 0; i < Math.min(bytes.length, 1000); i++) {
                    const byte = bytes[i];
                    // If we find bytes in the Windows-1252 special range, likely Windows-1252
                    if ((byte >= 0x80 && byte <= 0x9F) && byte !== 0x81 && byte !== 0x8D && byte !== 0x8F && byte !== 0x90 && byte !== 0x9D) {
                        return false; // Likely Windows-1252
                    }
                }
                
                return true; // Default to UTF-8
            };
            
            // Decode bytes as Windows-1252 encoding (also called CP1252)
            const decodeWindows1252 = (bytes) => {
                const chars = [];
                
                for (let i = 0; i < bytes.length; i++) {
                    const byte = bytes[i];
                    
                    // Handle Windows-1252 specific characters (0x80-0x9F range)
                    // These directly map to specific Unicode characters
                    if (byte === 0x80) chars.push(String.fromCharCode(0x20AC)); // ‚Ç¨
                    else if (byte === 0x82) chars.push(String.fromCharCode(0x201A)); // ‚Äö
                    else if (byte === 0x83) chars.push(String.fromCharCode(0x0192)); // ∆í
                    else if (byte === 0x84) chars.push(String.fromCharCode(0x201E)); // ‚Äû
                    else if (byte === 0x85) chars.push(String.fromCharCode(0x2026)); // ‚Ä¶
                    else if (byte === 0x86) chars.push(String.fromCharCode(0x2020)); // ‚Ä†
                    else if (byte === 0x87) chars.push(String.fromCharCode(0x2021)); // ‚Ä°
                    else if (byte === 0x88) chars.push(String.fromCharCode(0x02C6)); // ÀÜ
                    else if (byte === 0x89) chars.push(String.fromCharCode(0x2030)); // ‚Ä∞
                    else if (byte === 0x8A) chars.push(String.fromCharCode(0x0160)); // ≈†
                    else if (byte === 0x8B) chars.push(String.fromCharCode(0x2039)); // ‚Äπ
                    else if (byte === 0x8C) chars.push(String.fromCharCode(0x0152)); // ≈í
                    else if (byte === 0x8E) chars.push(String.fromCharCode(0x017D)); // ≈Ω
                    else if (byte === 0x91) chars.push("'"); // ' (left single quote) ‚Üí apostrophe
                    else if (byte === 0x92) chars.push("'"); // ' (right single quote) ‚Üí apostrophe
                    else if (byte === 0x93) chars.push('"'); // " (left double quote) ‚Üí quote
                    else if (byte === 0x94) chars.push('"'); // " (right double quote) ‚Üí quote
                    else if (byte === 0x95) chars.push(String.fromCharCode(0x2022)); // ‚Ä¢
                    else if (byte === 0x96) chars.push("-"); // ‚Äì (en dash) ‚Üí hyphen
                    else if (byte === 0x97) chars.push("-"); // ‚Äî (em dash) ‚Üí hyphen
                    else if (byte === 0x98) chars.push(String.fromCharCode(0x02DC)); // Àú
                    else if (byte === 0x99) chars.push(String.fromCharCode(0x2122)); // ‚Ñ¢
                    else if (byte === 0x9A) chars.push(String.fromCharCode(0x0161)); // ≈°
                    else if (byte === 0x9B) chars.push(String.fromCharCode(0x203A)); // ‚Ä∫
                    else if (byte === 0x9C) chars.push(String.fromCharCode(0x0153)); // ≈ì
                    else if (byte === 0x9E) chars.push(String.fromCharCode(0x017E)); // ≈æ
                    else if (byte === 0x9F) chars.push(String.fromCharCode(0x0178)); // ≈∏
                    // These are undefined in Windows-1252
                    else if (byte === 0x81 || byte === 0x8D || byte === 0x8F || byte === 0x90 || byte === 0x9D) {
                        chars.push(''); // Skip undefined characters
                    }
                    // Handle fraction characters (convert directly to ASCII)
                    else if (byte === 0xBC) chars.push('1/4'); // ¬º ‚Üí 1/4
                    else if (byte === 0xBD) chars.push('1/2'); // ¬Ω ‚Üí 1/2
                    else if (byte === 0xBE) chars.push('3/4'); // ¬æ ‚Üí 3/4
                    // For all other bytes, use ISO-8859-1 mapping (which is 1:1 with Unicode for 0x00-0xFF)
                    else {
                        chars.push(String.fromCharCode(byte));
                    }
                }
                
                return chars.join('');
            };
            
            // Parse the CSV text with Papa Parse
            const parseCSVText = (csvText) => {
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        parsedCsvData = results.data;
                        conversionStatus.textContent = `Successfully parsed ${parsedCsvData.length} rows.`;
                        generateXmlBtn.disabled = false;
                    },
                    error: (err) => {
                        conversionStatus.textContent = `CSV Parse Error: ${err.message}`;
                        conversionStatus.classList.add('text-red-500');
                        parsedCsvData = null;
                    }
                });
            };

            const validateAndFormatValue = (value, attributeType) => {
                if (!value || value.trim() === '') return value;
                
                switch (attributeType) {
                    case 'Boolean':
                        // Convert common boolean values to proper SFCC format (true/false)
                        const boolValue = value.toString().toLowerCase().trim();
                        // Map YES/TRUE/1 variations to true
                        if (boolValue === 'true' || boolValue === '1' || boolValue === 'yes' || boolValue === 'y' || boolValue === 'on') return 'true';
                        // Map NO/FALSE/0 variations to false  
                        if (boolValue === 'false' || boolValue === '0' || boolValue === 'no' || boolValue === 'n' || boolValue === 'off') return 'false';
                        // If already in correct format, preserve it
                        if (boolValue === 'true' || boolValue === 'false') return boolValue;
                        // For unrecognizable values, default to false and warn (in a real app we'd log this)
                        console.warn(`Unrecognized boolean value "${value}" - defaulting to false`);
                        return 'false';
                    
                    case 'Date':
                        // Ensure ISO date format if possible, otherwise return as-is
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                return date.toISOString().split('T')[0]; // YYYY-MM-DD format
                            }
                        } catch (e) {
                            // If parsing fails, return original value
                        }
                        return value;
                    
                    case 'Date+Time':
                        // Ensure ISO format if possible, otherwise return as-is
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                return date.toISOString();
                            }
                        } catch (e) {
                            // If parsing fails, return original value
                        }
                        return value;
                    
                    case 'Number':
                    case 'Quantity':
                        // Ensure numeric values are properly formatted
                        const numValue = parseFloat(value);
                        if (!isNaN(numValue)) {
                            return numValue.toString();
                        }
                        return value;
                    
                    case 'Integer':
                    case 'Enum of Integers':
                        // Ensure integer format
                        const intValue = parseInt(value);
                        if (!isNaN(intValue)) {
                            return intValue.toString();
                        }
                        return value;
                    
                    case 'Set of Strings':
                    case 'Set of Integers':
                    case 'Set of Numbers':
                        // Sets should be pipe-separated values in SFCC
                        if (value.includes(',')) {
                            return value.split(',').map(v => v.trim()).join('|');
                        }
                        return value;
                    
                    case 'Email':
                        // Basic email validation - just return as-is for now
                        return value.trim().toLowerCase();
                    
                    case 'Password':
                        // Passwords should not be transformed
                        return value;
                    
                    case 'String':
                    case 'Text':
                    case 'HTML':
                    case 'Image':
                    case 'Enum of Strings':
                    default:
                        return value;
                }
            };

            // Fix the ÔøΩ replacement character (U+FFFD) that appears from encoding issues
            const fixReplacementCharacters = (str) => {
                if (!str) return '';
                
                return str.toString()
                    // Replace ÔøΩ (replacement character U+FFFD) with apostrophe when between letters
                    .replace(/(\w)ÔøΩ(\w)/g, "$1'$2")
                    // Replace ÔøΩ with single quote for possessives
                    .replace(/(\w)ÔøΩs\b/g, "$1's")
                    // Replace ÔøΩ when used as fraction divider (e.g., "1ÔøΩ2" becomes "1/2")
                    .replace(/(\d+)\s*ÔøΩ\s*(\d+)/g, "$1/$2")
                    // Replace standalone ÔøΩ with dash (common for bullet points)
                    .replace(/^ÔøΩ\s*/g, "- ")
                    .replace(/\s+ÔøΩ\s+/g, " - ")
                    // Replace any remaining ÔøΩ with empty string or apostrophe depending on context
                    .replace(/ÔøΩ/g, "'");
            };
            
            // Normalize Unicode characters to prevent encoding issues
            const normalizeUnicodeCharacters = (str) => {
                if (!str) return '';
                
                return str.toString()
                    // FIRST: Fix apostrophes between digits (likely fractions that were misinterpreted)
                    .replace(/(\d+)\s*['‚Ä≤]\s*(\d+)/g, "$1/$2")  // "14 1'2" or "14 1‚Ä≤2" ‚Üí "14 1/2"
                    
                    // Normalize smart quotes to regular quotes
                    .replace(/[\u2018\u2019]/g, "'")  // Single smart quotes ‚Üí '
                    .replace(/[\u201C\u201D]/g, '"')  // Double smart quotes ‚Üí "
                    
                    // Normalize dashes and hyphens
                    .replace(/[\u2013\u2014]/g, '-')  // En dash, Em dash ‚Üí -
                    .replace(/\u2212/g, '-')          // Minus sign ‚Üí -
                    
                    // Normalize ellipsis
                    .replace(/\u2026/g, '...')        // Ellipsis ‚Üí ...
                    
                    // Normalize fractions and division
                    .replace(/\u2044/g, '/')          // Fraction slash ‚ÅÑ ‚Üí /
                    .replace(/\u2215/g, '/')          // Division slash ‚àï ‚Üí /
                    .replace(/[\u00BC-\u00BE]/g, (match) => {  // Vulgar fractions
                        const fractionMap = {
                            '\u00BC': '1/4',  // ¬º
                            '\u00BD': '1/2',  // ¬Ω
                            '\u00BE': '3/4'   // ¬æ
                        };
                        return fractionMap[match] || match;
                    })
                    
                    // Normalize spaces
                    .replace(/\u00A0/g, ' ')          // Non-breaking space ‚Üí space
                    .replace(/[\u2000-\u200B]/g, ' ') // Various Unicode spaces ‚Üí space
                    
                    // Normalize bullets and symbols
                    .replace(/\u2022/g, '*')          // Bullet ‚Üí *
                    .replace(/\u00B7/g, '*')          // Middle dot ‚Üí *
                    .replace(/\u00D7/g, 'x')          // Multiplication sign ‚Üí x
                    .replace(/\u00F7/g, '/')          // Division sign ‚Üí /
                    .replace(/\u00B0/g, ' degrees')   // Degree symbol ‚Üí degrees
                    
                    // Normalize currency symbols
                    .replace(/\u00A3/g, 'GBP')        // Pound sign ‚Üí GBP
                    .replace(/\u20AC/g, 'EUR')        // Euro sign ‚Üí EUR
                    .replace(/\u00A5/g, 'JPY')        // Yen sign ‚Üí JPY
                    
                    // Normalize accented characters to their base equivalents
                    .replace(/[\u00C0-\u00C5]/g, 'A')
                    .replace(/\u00C6/g, 'AE')
                    .replace(/\u00C7/g, 'C')
                    .replace(/[\u00C8-\u00CB]/g, 'E')
                    .replace(/[\u00CC-\u00CF]/g, 'I')
                    .replace(/\u00D1/g, 'N')
                    .replace(/[\u00D2-\u00D6]/g, 'O')
                    .replace(/\u00D8/g, 'O')
                    .replace(/[\u00D9-\u00DC]/g, 'U')
                    .replace(/[\u00DD-\u00DF]/g, 'Y')
                    .replace(/[\u00E0-\u00E5]/g, 'a')
                    .replace(/\u00E6/g, 'ae')
                    .replace(/\u00E7/g, 'c')
                    .replace(/[\u00E8-\u00EB]/g, 'e')
                    .replace(/[\u00EC-\u00EF]/g, 'i')
                    .replace(/\u00F1/g, 'n')
                    .replace(/[\u00F2-\u00F6]/g, 'o')
                    .replace(/\u00F8/g, 'o')
                    .replace(/[\u00F9-\u00FC]/g, 'u')
                    .replace(/[\u00FD-\u00FF]/g, 'y');
            };
            
            // Remove characters that are invalid in XML
            const removeInvalidXmlCharacters = (str) => {
                if (!str) return '';
                
                return str.toString().replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F-\x9F]/g, '');
            };

            const escapeXml = (unsafe) => {
                if (unsafe === null || unsafe === undefined) return '';
                
                // First fix replacement characters from encoding issues
                let safe = fixReplacementCharacters(unsafe);
                // Then normalize Unicode characters
                safe = normalizeUnicodeCharacters(safe);
                // Remove invalid XML chars
                safe = removeInvalidXmlCharacters(safe);
                
                // Finally escape XML special characters
                return safe.replace(/[<>&'"]/g, (c) => {
                    switch (c) {
                        case '<': return '&lt;';
                        case '>': return '&gt;';
                        case '&': return '&amp;';
                        case '\'': return '&apos;';
                        case '"': return '&quot;';
                    }
                });
            };

            const generateXML = () => {
                if (!parsedCsvData || !currentObjectType) {
                    conversionStatus.textContent = 'Error: Missing data or object type.';
                    conversionStatus.classList.add('text-red-500');
                    return;
                }
                
                // Define which object types require catalog ID
                const catalogRequiredTypes = ['Product', 'Category', 'VariationMapping', 'ProductRecommendation', 'CategoryAssignment', 'CategoryPosition', 'ImageMapping', 'VariationGroup', 'ProductSets'];
                
                // Validate Catalog ID for types that require it
                if (catalogRequiredTypes.includes(currentObjectType)) {
                    const catalogId = step3CatalogIdInput.value.trim();
                    if (!catalogId) {
                        conversionStatus.textContent = 'Error: Please enter a Catalog ID above.';
                        conversionStatus.classList.add('text-red-500');
                        // Scroll to the catalog ID field and highlight it
                        step3CatalogIdSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        step3CatalogIdInput.classList.add('border-red-500');
                        setTimeout(() => step3CatalogIdInput.classList.remove('border-red-500'), 3000);
                        return;
                    }
                }
                
                // Special validation for Prices (needs pricebook ID and currency, not catalog ID)
                if (currentObjectType === 'Prices') {
                    const pricebookId = step3PricebookIdInput.value.trim();
                    const currency = step3CurrencyInput.value.trim();
                    
                    if (!pricebookId) {
                        conversionStatus.textContent = 'Error: Please enter a Price Book ID above.';
                        conversionStatus.classList.add('text-red-500');
                        step3PricesSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        step3PricebookIdInput.classList.add('border-red-500');
                        setTimeout(() => step3PricebookIdInput.classList.remove('border-red-500'), 3000);
                        return;
                    }
                    if (!currency) {
                        conversionStatus.textContent = 'Error: Please enter a Currency above.';
                        conversionStatus.classList.add('text-red-500');
                        step3PricesSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        step3CurrencyInput.classList.add('border-red-500');
                        setTimeout(() => step3CurrencyInput.classList.remove('border-red-500'), 3000);
                        return;
                    }
                }
                
                // Special validation for Inventory (needs inventory list ID, not catalog ID)
                if (currentObjectType === 'Inventory') {
                    const inventoryListId = step3InventoryListIdInput.value.trim();
                    
                    if (!inventoryListId) {
                        conversionStatus.textContent = 'Error: Please enter an Inventory List ID above.';
                        conversionStatus.classList.add('text-red-500');
                        step3InventorySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        step3InventoryListIdInput.classList.add('border-red-500');
                        setTimeout(() => step3InventoryListIdInput.classList.remove('border-red-500'), 3000);
                        return;
                    }
                }
                
                // Get catalog ID from Step 3 input or use special values for non-catalog types
                const catalogId = catalogRequiredTypes.includes(currentObjectType)
                    ? step3CatalogIdInput.value.trim()
                    : (currentObjectType === 'Customer')
                    ? 'customers'
                    : (currentObjectType === 'StaticCustomerGroup')
                    ? staticGroupIdInput.value.trim()
                    : (currentObjectType === 'ContentAsset')
                    ? contentLibraryIdInput.value.trim()
                    : (currentObjectType === 'LibraryFolder')
                    ? folderLibraryIdInput.value.trim()
                    : (currentObjectType === 'Prices')
                    ? 'prices'
                    : (currentObjectType === 'Inventory')
                    ? 'inventory'
                    : '';
                const useLocale = localeCheckbox.checked;
                const selectedLocale = useLocale ? localeSelect.value : 'default';
                const useSiteSpecific = siteCheckbox.checked || siteCheckboxMoved.checked;
                const siteId = useSiteSpecific ? (siteIdInput.value.trim() || siteIdInputMoved.value.trim()) : '';
                const idField = `${currentObjectType}ID`;

                let itemsXml = '';
                const tagMap = {
                    Product: { main: 'product', id: 'product-id' },
                Category: { main: 'category', id: 'category-id' },
                VariationMapping: { main: 'product', id: 'product-id' },
                CategoryAssignment: { main: 'category-assignment', id: 'product-id' },
                ProductRecommendation: { main: 'recommendation', id: 'source-id' },
                CategoryPosition: { main: 'category-assignment', id: 'product-id' },
                ImageMapping: { main: 'product', id: 'product-id' },
                VariationGroup: { main: 'product', id: 'product-id' },
                Prices: { main: 'price-table', id: 'product-id' },
                Inventory: { main: 'record', id: 'product-id' },
                ContentAsset: { main: 'content', id: 'content-id' },
                Customer: { main: 'customer', id: 'customer-no' }
                };
                const currentTag = tagMap[currentObjectType];

                // Define localizable attributes that should include locale information
                const localizableAttributes = {
                    Product: ['shortDescription', 'longDescription', 'pageTitle', 'pageDescription', 'pageKeywords', 'pageURL', 'storeReceiptName'],
                    Category: ['displayName', 'description', 'pageTitle', 'pageDescription', 'pageKeywords', 'pageURL'],
                    ContentAsset: ['name', 'description', 'body', 'pageTitle', 'pageDescription', 'pageKeywords', 'pageURL', 'searchWords'],
                    Customer: [], // Customers don't have localizable attributes in this context
                    VariationMapping: []
                };
                const currentLocalizableAttrs = localizableAttributes[currentObjectType] || [];

                // Define proper element ordering according to SFCC schema
                const elementOrder = {
                    Product: [
                        'ean', 'upc', 'unit', 'unit-quantity', 'unit-measure', 'min-order-quantity', 'step-quantity',
                        'display-name', 'short-description', 'long-description', 'store-receipt-name', 'store-tax-class',
                        'store-force-price-flag', 'store-non-inventory-flag', 'store-non-revenue-flag', 'store-non-discountable-flag',
                        'online-flag', 'online-from', 'online-to', 'available-flag', 'searchable-flag', 'searchable-if-unavailable-flag',
                        'images', 'image', 'thumbnail', 'template', 'tax-class-id', 'localized-tax-class-id',
                        'brand', 'manufacturer-name', 'manufacturer-sku', 'search-placement', 'search-rank',
                        'sitemap-included-flag', 'sitemap-changefrequency', 'sitemap-priority', 'page-attributes',
                        'custom-attributes', 'bundled-products', 'retail-set-products', 'product-set-products', 
                        'options', 'variations', 'product-links', 'category-links', 'classification-category',
                        'pinterest-enabled-flag', 'facebook-enabled-flag', 'product-detail-page-meta-tag-rules',
                        'store-attributes', 'creation-date', 'last-modified', 'uuid'
                    ],
                    Category: [
                        'display-name', 'description', 'template', 'thumbnail', 'image', 'online-flag', 'online-from', 'online-to',
                        'show-in-menu', 'header-menu-banner', 'header-menu-orientation', 'alternative-url', 'enable-compare',
                        'featured-sorting-rule', 'display-mode', 'custom-css-file', 'cat-banner-id', 'slot-banner-image',
                        'slot-banner-html', 'size-chart-id', 'search-placement', 'search-rank', 'sitemap-included-flag',
                        'sitemap-changefrequency', 'sitemap-priority', 'page-attributes', 'custom-attributes',
                        'creation-date', 'last-modified', 'uuid'
                    ],
                    VariationMapping: [
                        'variations'
                    ],
                    ContentAsset: [
                        'name', 'description', 'template', 'online-flag', 'searchable-flag', 'page-title', 
                        'page-description', 'page-keywords', 'page-url', 'body', 'custom-attributes'
                    ],
                    Customer: [
                        'uuid', 'customer-no', 'first-name', 'last-name', 'second-name', 'suffix', 'title', 'salutation',
                        'email', 'phone-home', 'phone-business', 'phone-mobile', 'fax', 'job-title', 'company-name',
                        'birthday', 'next-birthday', 'gender', 'family-status', 'preferred-locale', 'tax-id', 'tax-id-type',
                        'is-pro', 'creation-date', 'last-modified', 'last-login-time', 'last-visit-time', 'custom-attributes'
                    ]
                };

                const currentElementOrder = elementOrder[currentObjectType] || [];

                parsedCsvData.forEach(row => {
                    // Handle VariationMapping separately due to its unique XML structure
                    // Note: This is handled after all rows are processed to group by base product
                    if (currentObjectType === 'VariationMapping') {
                        return; // Skip individual row processing, handled below
                    }

                    // Handle CategoryAssignment separately due to its unique XML structure
                    if (currentObjectType === 'CategoryAssignment') {
                        const productId = row['Product ID'];
                        const categoryId = row['Category ID'];
                        const isPrimaryCategory = row['Primary Category ID'] && row['Primary Category ID'].toString().toLowerCase() === 'true';
                        
                        if (!productId || !categoryId) return; // Both Product ID and Category ID are required
                        
                        // Generate category-assignment element
                        itemsXml += `\n    <${currentTag.main} category-id="${escapeXml(categoryId)}" ${currentTag.id}="${escapeXml(productId)}">`;
                        
                        // Add primary-flag if specified
                        if (isPrimaryCategory) {
                            itemsXml += '\n        <primary-flag>true</primary-flag>';
                        }
                        
                        itemsXml += `\n    </${currentTag.main}>`;
                        return;
                    }

                    // Handle ProductRecommendation separately due to its unique XML structure
                    if (currentObjectType === 'ProductRecommendation') {
                        const recommendationType = row['Recommendation Type'];
                        const targetId = row['Target ID'];
                        const sourceId = row['Source ID'];
                        if (!recommendationType || !targetId || !sourceId) return; // Skip rows without required data
                        
                        itemsXml += `\n    <${currentTag.main} type="${escapeXml(recommendationType)}" target-id="${escapeXml(targetId)}" source-type="product" source-id="${escapeXml(sourceId)}"></${currentTag.main}>`;
                        return;
                    }

                    // Handle CategoryPosition separately due to its unique XML structure
                    if (currentObjectType === 'CategoryPosition') {
                        const categoryId = row['Category ID'];
                        const productId = row['Product ID'];
                        const sortingType = sortingTypeSelect.value;
                        if (!categoryId || !productId || !sortingType) return; // Skip rows without required data
                        
                        itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(productId)}" category-id="${escapeXml(categoryId)}" mode="${escapeXml(sortingType)}"></${currentTag.main}>`;
                        return;
                    }

                    // Handle ImageMapping separately due to its unique XML structure
                    if (currentObjectType === 'ImageMapping') {
                        const productId = row['Product ID'];
                        if (!productId) return; // Skip rows without product ID
                        
                        const selectedType = document.querySelector('input[name="imageMappingType"]:checked')?.value;
                        
                        if (selectedType === 'flat') {
                            const largeImage = row['Large Image Path'];
                            const mediumImage = row['Medium Image Path'];
                            const smallImage = row['Small Image Path'];
                            const hiResImage = row['Hi-res Image Path'];
                            
                            // Skip if no images provided
                            if (!largeImage && !mediumImage && !smallImage && !hiResImage) return;
                            
                            itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(productId)}">`;
                            itemsXml += '\n        <images>';
                            
                            // Add image groups for each provided image
                            if (largeImage && largeImage.trim() !== '') {
                                itemsXml += `\n            <image-group view-type="large">`;
                                itemsXml += `\n                <image path="${escapeXml(largeImage.trim())}"/>`;
                                itemsXml += '\n            </image-group>';
                            }
                            if (mediumImage && mediumImage.trim() !== '') {
                                itemsXml += `\n            <image-group view-type="medium">`;
                                itemsXml += `\n                <image path="${escapeXml(mediumImage.trim())}"/>`;
                                itemsXml += '\n            </image-group>';
                            }
                            if (smallImage && smallImage.trim() !== '') {
                                itemsXml += `\n            <image-group view-type="small">`;
                                itemsXml += `\n                <image path="${escapeXml(smallImage.trim())}"/>`;
                                itemsXml += '\n            </image-group>';
                            }
                            if (hiResImage && hiResImage.trim() !== '') {
                                itemsXml += `\n            <image-group view-type="hi-res">`;
                                itemsXml += `\n                <image path="${escapeXml(hiResImage.trim())}"/>`;
                                itemsXml += '\n            </image-group>';
                            }
                            
                            itemsXml += '\n        </images>';
                            itemsXml += `\n    </${currentTag.main}>`;
                        } else if (selectedType === 'variation') {
                            const variationValue = row['Variation Value'];
                            if (!variationValue) return; // Skip rows without variation value
                            
                            itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(productId)}">`;
                            itemsXml += '\n        <images>';
                            itemsXml += `\n            <image-group view-type="image" variation-value="${escapeXml(variationValue)}">`;
                            
                            // Add all non-empty image paths
                            for (let i = 1; i <= 4; i++) {
                                const imagePathKey = `Image Path ${i}`;
                                const imagePath = row[imagePathKey];
                                if (imagePath && imagePath.trim() !== '') {
                                    itemsXml += `\n                <image path="${escapeXml(imagePath.trim())}"/>`;
                                }
                            }
                            
                            itemsXml += '\n            </image-group>';
                            itemsXml += '\n        </images>';
                            itemsXml += `\n    </${currentTag.main}>`;
                        }
                        return;
                    }

                    // Handle VariationGroup separately due to its unique XML structure
                    if (currentObjectType === 'VariationGroup') {
                        const masterProductId = row['Master Product ID'];
                        const variationGroupId = row['Variation Group ID'];
                        const groupingAttribute = row['Grouping Variation Attribute'];
                        const groupingValue = row['Grouping Variation Attribute Value'];
                        const onlineFlag = row['Online Flag'];
                        const availableFlag = row['Available Flag'];
                        const searchableFlag = row['Searchable Flag'];
                        
                        if (!masterProductId || !variationGroupId) return; // Skip rows without required IDs
                        
                        // Create master product with variation group reference
                        itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(masterProductId)}">`;
                        itemsXml += '\n        <variations>';
                        itemsXml += '\n            <variation-groups>';
                        itemsXml += `\n                <variation-group product-id="${escapeXml(variationGroupId)}"/>`;
                        itemsXml += '\n            </variation-groups>';
                        itemsXml += '\n        </variations>';
                        itemsXml += `\n    </${currentTag.main}>`;
                        
                        // Create variation group product with attributes
                        itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(variationGroupId)}">`;
                        
                        // Add flags
                        if (onlineFlag && onlineFlag.toString().toLowerCase() === 'true') {
                            itemsXml += '\n        <online-flag>true</online-flag>';
                        }
                        if (availableFlag && availableFlag.toString().toLowerCase() === 'true') {
                            itemsXml += '\n        <available-flag>true</available-flag>';
                        }
                        if (searchableFlag && searchableFlag.toString().toLowerCase() === 'true') {
                            itemsXml += '\n        <searchable-flag>true</searchable-flag>';
                        }
                        
                        // Add page attributes
                        itemsXml += '\n        <page-attributes/>';
                        
                        // Add custom attributes for grouping
                        if (groupingAttribute && groupingValue) {
                            itemsXml += '\n        <custom-attributes>';
                            
                            // Build attribute string with locale and site-specific support
                            let attributeString = ` attribute-id="${escapeXml(groupingAttribute)}"`;
                            
                            // Add locale attribute if specified
                            if (selectedLocale !== 'default') {
                                attributeString += ` xml:lang="${selectedLocale}"`;
                            }
                            
                            // Add site-specific attribute if specified
                            if (useSiteSpecific && siteId) {
                                attributeString += ` site-id="${siteId}"`;
                            }
                            
                            itemsXml += `\n            <custom-attribute${attributeString}>${escapeXml(groupingValue)}</custom-attribute>`;
                            itemsXml += '\n        </custom-attributes>';
                        }
                        
                        itemsXml += `\n    </${currentTag.main}>`;
                        return;
                    }

                    // Handle Prices separately due to its unique XML structure (pricebooks)
                    if (currentObjectType === 'Prices') {
                        const productId = row['Product ID'];
                        const price = row['Price'];
                        const onlineFrom = row['Online From'];
                        const onlineTo = row['Online To'];
                        
                        if (!productId || !price) return; // Skip rows without required data
                        
                        // Helper function to parse various date formats and convert to ISO format
                        const parseAndFormatDate = (dateStr) => {
                            if (!dateStr || dateStr.trim() === '') return null;
                            
                            const trimmed = dateStr.trim();
                            
                            // If already in ISO format (YYYY-MM-DDTHH:MM:SS.SSSZ), return as-is
                            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/.test(trimmed)) {
                                return trimmed;
                            }
                            
                            // If in YYYY-MM-DD format, append time
                            if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
                                return trimmed + 'T00:00:00.000Z';
                            }
                            
                            // Handle MM/DD/YY or MM/DD/YYYY formats (with various separators)
                            const datePatterns = [
                                // MM/DD/YY or M/D/YY (with / separator)
                                /^(\d{1,2})\/(\d{1,2})\/(\d{2})$/,
                                // MM/DD/YYYY or M/D/YYYY (with / separator)
                                /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,
                                // MM-DD-YY or M-D-YY (with - separator)
                                /^(\d{1,2})-(\d{1,2})-(\d{2})$/,
                                // MM-DD-YYYY or M-D-YYYY (with - separator)
                                /^(\d{1,2})-(\d{1,2})-(\d{4})$/
                            ];
                            
                            for (const pattern of datePatterns) {
                                const match = trimmed.match(pattern);
                                if (match) {
                                    let month = match[1].padStart(2, '0');
                                    let day = match[2].padStart(2, '0');
                                    let year = match[3];
                                    
                                    // Handle 2-digit years (assume 20xx for years 00-99)
                                    if (year.length === 2) {
                                        year = '20' + year;
                                    }
                                    
                                    return `${year}-${month}-${day}T00:00:00.000Z`;
                                }
                            }
                            
                            // Try to parse with JavaScript Date object as fallback
                            try {
                                const date = new Date(trimmed);
                                if (!isNaN(date.getTime())) {
                                    return date.toISOString();
                                }
                            } catch (e) {
                                console.warn(`Could not parse date: ${trimmed}`);
                            }
                            
                            // If all parsing attempts fail, return original value (will likely cause validation error)
                            return trimmed;
                        };
                        
                        itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(productId)}">`;
                        
                        // Add online-from if provided
                        if (onlineFrom && onlineFrom.trim() !== '') {
                            const formattedFrom = parseAndFormatDate(onlineFrom);
                            if (formattedFrom) {
                                itemsXml += `\n        <online-from>${escapeXml(formattedFrom)}</online-from>`;
                            }
                        }
                        
                        // Add online-to if provided
                        if (onlineTo && onlineTo.trim() !== '') {
                            const formattedTo = parseAndFormatDate(onlineTo);
                            if (formattedTo) {
                                itemsXml += `\n        <online-to>${escapeXml(formattedTo)}</online-to>`;
                            }
                        }
                        
                        // Add base amount with quantity 1.0
                        itemsXml += `\n        <amount quantity="1.0">${escapeXml(price)}</amount>`;
                        
                        // Add quantity pricing tiers (Quantity 2-10)
                        for (let i = 2; i <= 10; i++) {
                            const quantityKey = `Quantity ${i}`;
                            const priceKey = `Price ${i}`;
                            const quantity = row[quantityKey];
                            const tierPrice = row[priceKey];
                            
                            // Only add if both quantity and price are provided
                            if (quantity && quantity.toString().trim() !== '' && 
                                tierPrice && tierPrice.toString().trim() !== '') {
                                const quantityValue = parseFloat(quantity);
                                if (!isNaN(quantityValue) && quantityValue > 0) {
                                    itemsXml += `\n        <amount quantity="${quantityValue.toFixed(1)}">${escapeXml(tierPrice)}</amount>`;
                                }
                            }
                        }
                        
                        itemsXml += `\n    </${currentTag.main}>`;
                        return;
                    }

                    // Handle Inventory separately due to its unique XML structure (inventory)
                    if (currentObjectType === 'Inventory') {
                        const productId = row['Product ID'];
                        const allocation = row['Allocation'];
                        const perpetual = row['Perpetual'];
                        const preorderBackorder = row['Pre-order / Backorder'];
                        const preorderBackorderAllocation = row['Pre-order/Backorder Allocation'];
                        const preorderBackorderInStockDate = row['Pre-order / Backorder In-Stock Date'];
                        
                        // Only product ID is required - allocation can be blank/0 for perpetual or preorder/backorder scenarios
                        if (!productId) return; // Skip rows without product ID
                        
                        // Helper function to parse various date formats and convert to date-only format (YYYY-MM-DD)
                        // Note: Inventory in-stock-date requires date format, not dateTime
                        const parseAndFormatDate = (dateStr) => {
                            if (!dateStr || dateStr.trim() === '') return null;
                            
                            const trimmed = dateStr.trim();
                            
                            // If already in ISO datetime format, extract just the date part
                            if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/.test(trimmed)) {
                                return trimmed.split('T')[0];
                            }
                            
                            // If in YYYY-MM-DD format, return as-is
                            if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
                                return trimmed;
                            }
                            
                            // Handle MM/DD/YY or MM/DD/YYYY formats (with various separators)
                            const datePatterns = [
                                // MM/DD/YY or M/D/YY (with / separator)
                                /^(\d{1,2})\/(\d{1,2})\/(\d{2})$/,
                                // MM/DD/YYYY or M/D/YYYY (with / separator)
                                /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,
                                // MM-DD-YY or M-D-YY (with - separator)
                                /^(\d{1,2})-(\d{1,2})-(\d{2})$/,
                                // MM-DD-YYYY or M-D-YYYY (with - separator)
                                /^(\d{1,2})-(\d{1,2})-(\d{4})$/
                            ];
                            
                            for (const pattern of datePatterns) {
                                const match = trimmed.match(pattern);
                                if (match) {
                                    let month = match[1].padStart(2, '0');
                                    let day = match[2].padStart(2, '0');
                                    let year = match[3];
                                    
                                    // Handle 2-digit years (assume 20xx for years 00-99)
                                    if (year.length === 2) {
                                        year = '20' + year;
                                    }
                                    
                                    return `${year}-${month}-${day}`;
                                }
                            }
                            
                            // Try to parse with JavaScript Date object as fallback
                            try {
                                const date = new Date(trimmed);
                                if (!isNaN(date.getTime())) {
                                    return date.toISOString().split('T')[0];
                                }
                            } catch (e) {
                                console.warn(`Could not parse date: ${trimmed}`);
                            }
                            
                            // If all parsing attempts fail, return original value (will likely cause validation error)
                            return trimmed;
                        };
                        
                        itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(productId)}">`;
                        
                        // Add allocation (default to 0 if blank - required for perpetual inventory)
                        const allocationValue = allocation && allocation.toString().trim() !== '' ? allocation.toString().trim() : '0';
                        itemsXml += `\n        <allocation>${escapeXml(allocationValue)}</allocation>`;
                        
                        // Add perpetual (use robust boolean validation to handle various input formats)
                        const perpetualValue = perpetual && perpetual.toString().trim() !== '' 
                            ? validateAndFormatValue(perpetual, 'Boolean') 
                            : 'false';
                        itemsXml += `\n        <perpetual>${perpetualValue}</perpetual>`;
                        
                        // Add preorder-backorder-handling (normalize various spellings to valid SFCC values)
                        let handlingValue = 'none';
                        if (preorderBackorder && preorderBackorder.trim() !== '') {
                            const normalized = preorderBackorder.trim().toLowerCase().replace(/[\s\-_]/g, ''); // Remove spaces, hyphens, underscores
                            if (normalized === 'preorder') {
                                handlingValue = 'preorder';
                            } else if (normalized === 'backorder') {
                                handlingValue = 'backorder';
                            } else if (normalized === 'none' || normalized === '') {
                                handlingValue = 'none';
                            } else {
                                // Default to 'none' for unrecognized values but log a warning
                                console.warn(`Unrecognized preorder-backorder-handling value "${preorderBackorder}" - defaulting to "none". Valid values are: preorder, backorder, none`);
                                handlingValue = 'none';
                            }
                        }
                        itemsXml += `\n        <preorder-backorder-handling>${escapeXml(handlingValue)}</preorder-backorder-handling>`;
                        
                        // Add preorder-backorder-allocation
                        const preorderAllocationValue = preorderBackorderAllocation && preorderBackorderAllocation.toString().trim() !== '' ? preorderBackorderAllocation.toString().trim() : '0';
                        itemsXml += `\n        <preorder-backorder-allocation>${escapeXml(preorderAllocationValue)}</preorder-backorder-allocation>`;
                        
                        // Add preorder-backorder-instock-date if provided (for preorder/backorder items)
                        if (preorderBackorderInStockDate && preorderBackorderInStockDate.trim() !== '') {
                            const formattedDate = parseAndFormatDate(preorderBackorderInStockDate);
                            if (formattedDate) {
                                itemsXml += `\n        <in-stock-date>${escapeXml(formattedDate)}</in-stock-date>`;
                            }
                        }
                        
                        itemsXml += `\n    </${currentTag.main}>`;
                        return;
                    }

                    // Handle ContentAsset separately due to its unique XML structure
                    if (currentObjectType === 'ContentAsset') {
                        const contentId = row['ContentAssetID'];
                        if (!contentId) return; // Skip rows without content ID
                        
                        itemsXml += `\n    <content content-id="${escapeXml(contentId)}">`;
                        
                        // Handle display-name (mapped from name)
                        if (row['name']) {
                            itemsXml += `\n        <display-name xml:lang="x-default">${escapeXml(row['name'])}</display-name>`;
                        }
                        
                        // Handle standard attributes (excluding page attributes and folder)
                        const pageAttributes = ['pageTitle', 'pageDescription', 'pageKeywords', 'pageURL'];
                        const skipAttributes = ['name', 'folder', ...pageAttributes];
                        
                        Object.keys(row).forEach(key => {
                            if (key !== 'ContentAssetID' && !skipAttributes.includes(key) && row[key] && row[key].trim() !== '') {
                                const xmlKey = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                                const value = row[key].trim();
                                
                                if (key === 'body') {
                                    // Handle body as custom attribute with CDATA
                                    // Will be handled in custom attributes section
                                } else {
                                    itemsXml += `\n        <${xmlKey}>${escapeXml(value)}</${xmlKey}>`;
                                }
                            }
                        });
                        
                        // Handle page attributes
                        const hasPageAttrs = pageAttributes.some(attr => row[attr] && row[attr].trim() !== '');
                        if (hasPageAttrs) {
                            itemsXml += `\n        <page-attributes>`;
                            pageAttributes.forEach(attr => {
                                if (row[attr] && row[attr].trim() !== '') {
                                    const xmlKey = attr.replace(/([A-Z])/g, '-$1').toLowerCase();
                                    itemsXml += `\n            <${xmlKey} xml:lang="x-default">${escapeXml(row[attr].trim())}</${xmlKey}>`;
                                }
                            });
                            itemsXml += `\n        </page-attributes>`;
                        }
                        
                        // Handle custom attributes (including body)
                        const hasCustomAttrs = Object.keys(customAttributeTypes).length > 0 || row['body'];
                        if (hasCustomAttrs) {
                            itemsXml += `\n        <custom-attributes>`;
                            
                            // Handle body as custom attribute
                            if (row['body'] && row['body'].trim() !== '') {
                                itemsXml += `\n            <custom-attribute attribute-id="body" xml:lang="x-default"><![CDATA[${row['body'].trim()}]]></custom-attribute>`;
                            }
                            
                            // Handle other custom attributes
                            Object.keys(customAttributeTypes).forEach(customAttr => {
                                if (customAttr !== 'body' && row[customAttr] && row[customAttr].trim() !== '') {
                                    itemsXml += `\n            <custom-attribute attribute-id="${customAttr}" xml:lang="x-default">${escapeXml(row[customAttr].trim())}</custom-attribute>`;
                                }
                            });
                            
                            itemsXml += `\n        </custom-attributes>`;
                        }
                        
                        // Handle folder links
                        if (row['folder'] && row['folder'].trim() !== '') {
                            itemsXml += `\n        <folder-links>`;
                            itemsXml += `\n            <classification-link folder-id="${escapeXml(row['folder'].trim())}"/>`;
                            itemsXml += `\n        </folder-links>`;
                        }
                        
                        itemsXml += `\n    </content>`;
                        return;
                    }

                    // Handle LibraryFolder separately due to its unique XML structure
                    if (currentObjectType === 'LibraryFolder') {
                        const folderId = row['ID'];
                        if (!folderId) return; // Skip rows without folder ID
                        
                        itemsXml += `\n    <folder folder-id="${escapeXml(folderId)}">`;
                        
                        // Handle display-name
                        if (row['Display Name']) {
                            itemsXml += `\n        <display-name xml:lang="x-default">${escapeXml(row['Display Name'])}</display-name>`;
                        }
                        
                        // Handle description
                        if (row['Description']) {
                            itemsXml += `\n        <description xml:lang="x-default">${escapeXml(row['Description'])}</description>`;
                        }
                        
                        // Handle template (empty)
                        itemsXml += `\n        <template></template>`;
                        
                        // Handle parent
                        if (row['Parent']) {
                            itemsXml += `\n        <parent>${escapeXml(row['Parent'])}</parent>`;
                        }
                        
                        // Handle page-attributes (empty)
                        itemsXml += `\n        <page-attributes/>`;
                        
                        itemsXml += `\n    </folder>`;
                        return;
                    }

                    // Handle StaticCustomerGroup separately due to its unique XML structure
                    if (currentObjectType === 'StaticCustomerGroup') {
                        const customerNo = row['Customer Number'];
                        if (!customerNo) return; // Skip rows without customer number
                        
                        const groupId = staticGroupIdInput.value.trim();
                        itemsXml += `\n    <group-assignment group-id="${escapeXml(groupId)}" customer-no="${escapeXml(customerNo)}"/>`;
                        return;
                    }

                    // Handle ProductSets separately due to its unique structure
                    if (currentObjectType === 'ProductSets') {
                        const productSetId = row['Product Set ID'];
                        
                        if (!productSetId) return; // Skip incomplete rows
                        
                        // Start product set XML
                        itemsXml += `\n    <product product-id="${escapeXml(productSetId)}">`;
                        
                        // Add selected standard attributes
                        const pageAttributeNames = ['pageTitle', 'pageDescription', 'pageKeywords', 'pageURL'];
                        const standardElements = [];
                        const pageElements = [];
                        
                        productSetsSelectedAttributes.forEach(attr => {
                            const value = row[attr];
                            if (value !== undefined && value !== '') {
                                const attrType = attributeData.Product[attr];
                                const formattedValue = validateAndFormatValue(value, attrType);
                                const elementName = attr.replace(/([A-Z])/g, '-$1').toLowerCase();
                                const isSiteSpecific = siteSpecificAttributes.includes(attr);
                                const isLocalizable = localizableProductAttributes.includes(attr);
                                
                                if (pageAttributeNames.includes(attr)) {
                                    pageElements.push({ elementName, value: formattedValue, key: attr });
                                } else {
                                    standardElements.push({ elementName, value: formattedValue, key: attr, isSiteSpecific, isLocalizable });
                                }
                            }
                        });
                        
                        // Add standard elements
                        standardElements.forEach(elem => {
                            let elementAttributes = '';
                            if (elem.isLocalizable && selectedLocale !== 'default') {
                                elementAttributes += ` xml:lang="${selectedLocale}"`;
                            }
                            if (useSiteSpecific && siteId && elem.isSiteSpecific) {
                                elementAttributes += ` site-id="${siteId}"`;
                            }
                            itemsXml += `\n        <${elem.elementName}${elementAttributes}>${escapeXml(elem.value)}</${elem.elementName}>`;
                        });
                        
                        // Add page attributes if any
                        if (pageElements.length > 0) {
                            itemsXml += `\n        <page-attributes>`;
                            pageElements.forEach(elem => {
                                let elementAttributes = '';
                                if (selectedLocale !== 'default') {
                                    elementAttributes += ` xml:lang="${selectedLocale}"`;
                                } else {
                                    elementAttributes += ` xml:lang="x-default"`;
                                }
                                if (useSiteSpecific && siteId) {
                                    elementAttributes += ` site-id="${siteId}"`;
                                }
                                itemsXml += `\n            <${elem.elementName}${elementAttributes}>${escapeXml(elem.value)}</${elem.elementName}>`;
                            });
                            itemsXml += `\n        </page-attributes>`;
                        }
                        
                        // Add custom attributes if any
                        if (productSetsCustomAttributes.length > 0) {
                            itemsXml += `\n        <custom-attributes>`;
                            productSetsCustomAttributes.forEach(attr => {
                                const value = row[attr.id];
                                if (value) {
                                    const formattedValue = validateAndFormatValue(value, attr.type);
                                    
                                    // Build attribute string with locale and site-specific support based on attribute flags
                                    let attributeString = ` attribute-id="${escapeXml(attr.id)}"`;
                                    
                                    // Add locale attribute if this attribute is marked as localizable
                                    if (attr.localizable && selectedLocale !== 'default') {
                                        attributeString += ` xml:lang="${selectedLocale}"`;
                                    }
                                    
                                    // Add site-specific attribute if this attribute is marked as site-specific
                                    if (attr.siteSpecific && useSiteSpecific && siteId) {
                                        attributeString += ` site-id="${siteId}"`;
                                    }
                                    
                                    itemsXml += `\n            <custom-attribute${attributeString}>${escapeXml(formattedValue)}</custom-attribute>`;
                                }
                            });
                            itemsXml += `\n        </custom-attributes>`;
                        }
                        
                        // Add product set products
                        itemsXml += `\n        <product-set-products>`;
                        
                        // Process product IDs from after custom attributes (up to 100)
                        for (let i = 1; i <= 100; i++) {
                            const productId = row[`Product ID ${i}`];
                            if (productId && productId.trim()) {
                                itemsXml += `\n            <product-set-product product-id="${escapeXml(productId.trim())}"/>`;
                            }
                        }
                        
                        itemsXml += `\n        </product-set-products>`;
                        itemsXml += `\n    </product>`;
                        return;
                    }

                    // Handle standard Product and Category objects
                    const itemId = row[idField];
                    if (!itemId) return; // Skip rows without an ID

                    // Define page attribute names
                    const pageAttributeNames = ['pageTitle', 'pageDescription', 'pageKeywords', 'pageURL'];
                    
                    // Backward compatibility mapping for old attribute names to new ones
                    const attributeNameMap = {
                        'searchable': 'searchableFlag',
                        'online': 'onlineFlag'
                    };
                    
                    // Separate standard, page, and custom attributes
                    const standardElements = [];
                    const pageElements = [];
                    const customElements = [];
                    
                    for (const key in row) {
                        if (key !== idField) {
                            // Map old attribute names to new ones for backward compatibility
                            const mappedKey = attributeNameMap[key] || key;
                            const isStandardAttribute = Object.keys(currentStandardAttributes).includes(mappedKey);
                            const isPageAttribute = pageAttributeNames.includes(mappedKey);
                            const isCustomAttribute = customAttributeTypes.hasOwnProperty(key);
                            
                            // Check if this attribute was selected by the user
                            const isSelected = selectedAttributes.has(mappedKey) || selectedAttributes.has(key) || isCustomAttribute;
                            
                            // Include attribute if it has a value OR if it was selected (allows blank values for bulk delete)
                            if (row[key] || isSelected) {
                                if (isStandardAttribute && isPageAttribute) {
                                    // Page attributes should be wrapped in page-attributes container
                                    const elementName = mappedKey.replace(/([A-Z])/g, '-$1').toLowerCase();
                                    pageElements.push({ key: mappedKey, elementName, value: row[key] || '' });
                                } else if (isStandardAttribute) {
                                    const elementName = mappedKey.replace(/([A-Z])/g, '-$1').toLowerCase();
                                    standardElements.push({ key: mappedKey, elementName, value: row[key] || '' });
                                } else if (isCustomAttribute || isSelected) {
                                    // Custom attributes keep their original ID format
                                    customElements.push({ key, value: row[key] || '' });
                                }
                            }
                        }
                    }

                    // Sort standard elements according to schema order
                    standardElements.sort((a, b) => {
                        const orderA = currentElementOrder.indexOf(a.elementName);
                        const orderB = currentElementOrder.indexOf(b.elementName);
                        // If element not in order list, put it at the end
                        const indexA = orderA === -1 ? 9999 : orderA;
                        const indexB = orderB === -1 ? 9999 : orderB;
                        return indexA - indexB;
                    });

                    let itemContent = '';
                    let pageAttributesInserted = false;
                    const pageAttributesPosition = currentElementOrder.indexOf('page-attributes');
                    
                    // Add standard elements
                    standardElements.forEach((element, index) => {
                        // Check if we should insert page-attributes before this element
                        if (!pageAttributesInserted && pageElements.length > 0) {
                            const currentPosition = currentElementOrder.indexOf(element.elementName);
                            if (currentPosition > pageAttributesPosition || currentPosition === -1) {
                                // Insert page-attributes container before this element
                                itemContent += '\n        <page-attributes>';
                                
                                // Sort page elements in the correct order
                                const pageElementOrder = ['page-title', 'page-description', 'page-keywords', 'page-url'];
                                pageElements.sort((a, b) => {
                                    const orderA = pageElementOrder.indexOf(a.elementName);
                                    const orderB = pageElementOrder.indexOf(b.elementName);
                                    return orderA - orderB;
                                });
                                
                                pageElements.forEach(pageElement => {
                                    const attributeType = getAttributeType(pageElement.key);
                                    const formattedValue = validateAndFormatValue(pageElement.value, attributeType);
                                    
                                    // Page attributes are always localizable
                                    let elementAttributes = '';
                                    if (selectedLocale !== 'default') {
                                        elementAttributes += ` xml:lang="${selectedLocale}"`;
                                    }
                                    if (useSiteSpecific && siteId) {
                                        elementAttributes += ` site-id="${siteId}"`;
                                    }
                                    
                                    itemContent += `\n            <${pageElement.elementName}${elementAttributes}>${escapeXml(formattedValue)}</${pageElement.elementName}>`;
                                });
                                
                                itemContent += '\n        </page-attributes>';
                                pageAttributesInserted = true;
                            }
                        }
                        
                        // Get the attribute type and validate/format the value
                        const attributeType = getAttributeType(element.key);
                        const formattedValue = validateAndFormatValue(element.value, attributeType);
                        
                        // Check if this attribute is localizable
                        const isLocalizable = localizableProductAttributes.includes(element.key) || 
                            currentLocalizableAttrs.some(attr => 
                                attr.toLowerCase() === element.key.toLowerCase() || 
                                attr.replace(/([A-Z])/g, '-$1').toLowerCase() === element.elementName
                            );
                        
                        // Check if this attribute is site-specific
                        const isSiteSpecific = siteSpecificAttributes.includes(element.key);
                        
                        let elementAttributes = '';
                        if (isLocalizable && selectedLocale !== 'default') {
                            elementAttributes += ` xml:lang="${selectedLocale}"`;
                        }
                        if (useSiteSpecific && siteId && isSiteSpecific) {
                            elementAttributes += ` site-id="${siteId}"`;
                        }
                        
                        itemContent += `\n        <${element.elementName}${elementAttributes}>${escapeXml(formattedValue)}</${element.elementName}>`;
                    });
                    
                    // If we have page attributes but haven't inserted them yet (no standard elements after page-attributes position)
                    if (!pageAttributesInserted && pageElements.length > 0) {
                        itemContent += '\n        <page-attributes>';
                        
                        const pageElementOrder = ['page-title', 'page-description', 'page-keywords', 'page-url'];
                        pageElements.sort((a, b) => {
                            const orderA = pageElementOrder.indexOf(a.elementName);
                            const orderB = pageElementOrder.indexOf(b.elementName);
                            return orderA - orderB;
                        });
                        
                        pageElements.forEach(pageElement => {
                            const attributeType = getAttributeType(pageElement.key);
                            const formattedValue = validateAndFormatValue(pageElement.value, attributeType);
                            
                            let elementAttributes = '';
                            if (selectedLocale !== 'default') {
                                elementAttributes += ` xml:lang="${selectedLocale}"`;
                            }
                            if (useSiteSpecific && siteId) {
                                elementAttributes += ` site-id="${siteId}"`;
                            }
                            
                            itemContent += `\n            <${pageElement.elementName}${elementAttributes}>${escapeXml(formattedValue)}</${pageElement.elementName}>`;
                        });
                        
                        itemContent += '\n        </page-attributes>';
                    }

                    // Add custom attributes section if there are any custom attributes
                    if (customElements.length > 0) {
                        itemContent += '\n        <custom-attributes>';
                        customElements.forEach(element => {
                            // Get the custom attribute type and validate/format the value
                            const attributeType = getAttributeType(element.key);
                            const formattedValue = validateAndFormatValue(element.value, attributeType);
                            
                            // Check if this specific custom attribute is marked as localizable or site-specific
                            const attrFlags = customAttributeFlags[element.key] || {};
                            const isLocalizable = attrFlags.localizable || false;
                            const isSiteSpecific = attrFlags.siteSpecific || false;
                            
                            let elementAttributes = ` attribute-id="${element.key}"`;
                            if (isLocalizable && selectedLocale !== 'default') {
                                elementAttributes += ` xml:lang="${selectedLocale}"`;
                            }
                            if (useSiteSpecific && siteId && isSiteSpecific) {
                                elementAttributes += ` site-id="${siteId}"`;
                            }
                            
                            itemContent += `\n            <custom-attribute${elementAttributes}>${escapeXml(formattedValue)}</custom-attribute>`;
                        });
                        itemContent += '\n        </custom-attributes>';
                    }

                    itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${itemId}">${itemContent}\n    </${currentTag.main}>`;
                });
                
                // Handle Variation Mapping after all rows are processed (group by base product)
                if (currentObjectType === 'VariationMapping') {
                    // Group variants by base product and collect variation attribute values
                    const baseProductMap = {};
                    const variationAttributesMap = {}; // Map of attrId -> { displayName, values: Set }
                    
                    parsedCsvData.forEach(row => {
                        const variantId = row['Variation Product ID'];
                        const baseProductId = row['Base Product ID'];
                        const onlineFlag = row['onlineFlag'];
                        const searchableFlag = row['searchableFlag'];
                        
                        if (!variantId || !baseProductId) return; // Skip invalid rows
                        
                        // Track base products and their variants
                        if (!baseProductMap[baseProductId]) {
                            baseProductMap[baseProductId] = {
                                variants: [],
                                hasVariationAttributes: false
                            };
                        }
                        
                        // Dynamically detect all variation attributes (pattern: "Variation Attribute ID N")
                        const variantAttributes = {}; // Map of attrId -> varValue for this specific variant
                        
                        // Find all variation attribute columns by looking for the pattern
                        for (const columnName in row) {
                            const attrIdMatch = columnName.match(/^Variation Attribute ID (\d+)$/);
                            if (attrIdMatch) {
                                const attrNum = attrIdMatch[1];
                                const attrId = row[`Variation Attribute ID ${attrNum}`];
                                const attrName = row[`Variation Attribute Name ${attrNum}`];
                                const varValue = row[`Variation Value ${attrNum}`];
                                const varValueDisplay = row[`Variation Value Display ${attrNum}`];
                                
                                // Only process if attribute ID is provided
                                if (attrId && attrId.trim() !== '') {
                                    const trimmedAttrId = attrId.trim();
                                    baseProductMap[baseProductId].hasVariationAttributes = true;
                                    
                                    // Track this variation attribute globally
                                    if (!variationAttributesMap[trimmedAttrId]) {
                                        variationAttributesMap[trimmedAttrId] = {
                                            displayName: attrName ? attrName.trim() : trimmedAttrId,
                                            values: new Map() // Map of value -> displayValue
                                        };
                                    }
                                    
                                    // Add this variation value to the attribute's values (only if provided)
                                    if (varValue && varValue.trim() !== '') {
                                        const trimmedValue = varValue.trim();
                                        const trimmedValueDisplay = varValueDisplay ? varValueDisplay.trim() : trimmedValue;
                                        variationAttributesMap[trimmedAttrId].values.set(trimmedValue, trimmedValueDisplay);
                                        
                                        // Store for this specific variant
                                        variantAttributes[trimmedAttrId] = trimmedValue;
                                    }
                                }
                            }
                        }
                        
                        // Add variant info
                        baseProductMap[baseProductId].variants.push({
                            id: variantId.trim(),
                            attributes: variantAttributes, // All variation attributes for this variant
                            onlineFlag: onlineFlag ? onlineFlag.trim() : null,
                            searchableFlag: searchableFlag ? searchableFlag.trim() : null
                        });
                    });
                    
                    // Generate XML for each base product and its variants
                    for (const baseProductId in baseProductMap) {
                        const baseProduct = baseProductMap[baseProductId];
                        
                        // First, create a minimal product entry for the base product (so it exists)
                        itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(baseProductId)}">`;
                        itemsXml += `\n    </${currentTag.main}>`;
                        
                        // Next, create product entries for each variant product
                        for (const variant of baseProduct.variants) {
                            itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(variant.id)}">`;
                            
                            // Add onlineFlag if specified
                            if (variant.onlineFlag) {
                                const onlineValue = validateAndFormatValue(variant.onlineFlag, 'Boolean');
                                itemsXml += `\n        <online-flag>${onlineValue}</online-flag>`;
                            }
                            
                            // Add searchableFlag if specified
                            if (variant.searchableFlag) {
                                const searchableValue = validateAndFormatValue(variant.searchableFlag, 'Boolean');
                                itemsXml += `\n        <searchable-flag>${searchableValue}</searchable-flag>`;
                            }
                            
                            // Add custom-attributes section if any variation attributes are specified
                            if (Object.keys(variant.attributes).length > 0) {
                                itemsXml += `\n        <custom-attributes>`;
                                for (const attrId in variant.attributes) {
                                    const attrValue = variant.attributes[attrId];
                                    itemsXml += `\n            <custom-attribute attribute-id="${escapeXml(attrId)}">${escapeXml(attrValue)}</custom-attribute>`;
                                }
                                itemsXml += `\n        </custom-attributes>`;
                            }
                            
                            itemsXml += `\n    </${currentTag.main}>`;
                        }
                        
                        // Now create/update the base product with variation mapping
                        itemsXml += `\n    <${currentTag.main} ${currentTag.id}="${escapeXml(baseProductId)}">`;
                        
                        // Only add variations section if there are variation attributes
                        if (baseProduct.hasVariationAttributes && Object.keys(variationAttributesMap).length > 0) {
                            itemsXml += '\n        <variations>';
                            itemsXml += '\n            <attributes>';
                            
                            for (const attrId in variationAttributesMap) {
                                const attrData = variationAttributesMap[attrId];
                                itemsXml += `\n                <variation-attribute attribute-id="${escapeXml(attrId)}" variation-attribute-id="${escapeXml(attrId)}">`;
                                itemsXml += `\n                    <display-name xml:lang="x-default">${escapeXml(attrData.displayName)}</display-name>`;
                                
                                // Add variation-attribute-values section
                                if (attrData.values.size > 0) {
                                    itemsXml += '\n                    <variation-attribute-values>';
                                    
                                    for (const [value, displayValue] of attrData.values) {
                                        itemsXml += `\n                        <variation-attribute-value value="${escapeXml(value)}">`;
                                        itemsXml += `\n                            <display-value xml:lang="x-default">${escapeXml(displayValue)}</display-value>`;
                                        itemsXml += '\n                        </variation-attribute-value>';
                                    }
                                    
                                    itemsXml += '\n                    </variation-attribute-values>';
                                }
                                
                                itemsXml += '\n                </variation-attribute>';
                            }
                            
                            itemsXml += '\n            </attributes>';
                            itemsXml += '\n            <variants>';
                            
                            // Add variant references
                            for (const variant of baseProduct.variants) {
                                itemsXml += `\n                <variant product-id="${escapeXml(variant.id)}"/>`;
                            }
                            
                            itemsXml += '\n            </variants>';
                            itemsXml += '\n        </variations>';
                        } else {
                            // No variation attributes, just add the variants section
                            itemsXml += '\n        <variations>';
                            itemsXml += '\n            <variants>';
                            
                            // Add variant references
                            for (const variant of baseProduct.variants) {
                                itemsXml += `\n                <variant product-id="${escapeXml(variant.id)}"/>`;
                            }
                            
                            itemsXml += '\n            </variants>';
                            itemsXml += '\n        </variations>';
                        }
                        
                        itemsXml += `\n    </${currentTag.main}>`;
                    }
                }
                
                let finalXml;
                if (currentObjectType === 'Prices') {
                    // Use pricebooks structure for Prices
                    const pricebookId = step3PricebookIdInput.value.trim();
                    const currency = step3CurrencyInput.value.trim();
                    finalXml = `<?xml version="1.0" encoding="UTF-8"?>\n<pricebooks xmlns="http://www.demandware.com/xml/impex/pricebook/2006-10-31">\n    <pricebook>\n        <header pricebook-id="${pricebookId}">\n            <currency>${currency}</currency>\n        </header>\n        <price-tables>${itemsXml}\n        </price-tables>\n    </pricebook>\n</pricebooks>`;
                } else if (currentObjectType === 'Inventory') {
                    // Use inventory structure for Inventory
                    const inventoryListId = step3InventoryListIdInput.value.trim();
                    finalXml = `<?xml version="1.0" encoding="UTF-8"?>\n<inventory xmlns="http://www.demandware.com/xml/impex/inventory/2007-05-31">\n    <inventory-list>\n        <header list-id="${inventoryListId}">\n            <default-instock>false</default-instock>\n        </header>\n        <records>${itemsXml}\n        </records>\n    </inventory-list>\n</inventory>`;
                } else if (currentObjectType === 'ContentAsset') {
                    // Use library structure for Content Assets
                    finalXml = `<?xml version="1.0" encoding="UTF-8"?>\n<library xmlns="http://www.demandware.com/xml/impex/library/2006-10-31">${itemsXml}\n</library>`;
                } else if (currentObjectType === 'LibraryFolder') {
                    // Use library structure for Library Folders
                    const libraryId = folderLibraryIdInput.value.trim();
                    finalXml = `<?xml version="1.0" encoding="UTF-8"?>\n<library xmlns="http://www.demandware.com/xml/impex/library/2006-10-31" library-id="${libraryId}">${itemsXml}\n</library>`;
                } else if (currentObjectType === 'Customer') {
                    // Use customers structure for Customer imports
                    finalXml = `<?xml version="1.0" encoding="UTF-8"?>\n<customers xmlns="http://www.demandware.com/xml/impex/customer/2006-10-31">${itemsXml}\n</customers>`;
                } else if (currentObjectType === 'StaticCustomerGroup') {
                    // Use customer-groups structure for Static Customer Group imports
                    finalXml = `<?xml version="1.0" encoding="UTF-8"?>\n<customer-groups xmlns="http://www.demandware.com/xml/impex/customergroup/2007-06-30">${itemsXml}\n</customer-groups>`;
                } else {
                    // Use catalog structure for other types
                    finalXml = `<?xml version="1.0" encoding="UTF-8"?>\n<catalog xmlns="http://www.demandware.com/xml/impex/catalog/2006-10-31" catalog-id="${catalogId}">${itemsXml}\n</catalog>`;
                }
                
                const localeString = currentObjectType === 'ContentAsset' 
                    ? contentLocaleSelect.value.trim() 
                    : currentObjectType === 'LibraryFolder'
                    ? folderLocaleSelect.value.trim()
                    : (selectedLocale !== 'default' ? selectedLocale : 'default');
                downloadFile(finalXml, 'application/xml', `b2c_${currentObjectType.toLowerCase()}_import_${localeString}.xml`);
            };
            
            // Helper function to hide all help sections
            function hideAllHelpSections() {
                productAttributesDescription.classList.add('hidden');
                categoryAttributesHelp.classList.add('hidden');
                productRecommendationHelp.classList.add('hidden');
                variationMappingHelp.classList.add('hidden');
                categoryAssignmentHelp.classList.add('hidden');
                categoryPositionHelp.classList.add('hidden');
                imageMappingHelp.classList.add('hidden');
                variationGroupHelp.classList.add('hidden');
                pricesHelp.classList.add('hidden');
                inventoryHelp.classList.add('hidden');
                contentAssetHelp.classList.add('hidden');
                libraryFolderHelp.classList.add('hidden');
                staticCustomerGroupHelp.classList.add('hidden');
                productSetsHelp.classList.add('hidden');
                customerHelp.classList.add('hidden');
            }

            // --- Event Listeners ---
            objectTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                currentObjectType = e.target.value;
                currentStandardAttributes = attributeData[currentObjectType];
                selectedAttributes.clear();
                    customAttributeTypes = {}; // Reset custom attribute types
                    customAttributeFlags = {}; // Reset custom attribute flags
                parsedCsvData = null;
                    
                    // Auto-select folder for ContentAsset
                    if (currentObjectType === 'ContentAsset') {
                        selectedAttributes.add('folder');
                    }

                attributeSection.classList.remove('hidden');
                conversionSection.classList.remove('hidden');
                
                // Hide all help sections first
                hideAllHelpSections();
                
                // Show/hide Step 3 fields based on object type
                const catalogRequiredTypes = ['Product', 'Category', 'VariationMapping', 'ProductRecommendation', 'CategoryAssignment', 'CategoryPosition', 'ImageMapping', 'VariationGroup', 'ProductSets'];
                if (catalogRequiredTypes.includes(currentObjectType)) {
                    step3CatalogIdSection.classList.remove('hidden');
                } else {
                    step3CatalogIdSection.classList.add('hidden');
                }
                
                // Show/hide Prices fields
                if (currentObjectType === 'Prices') {
                    step3PricesSection.classList.remove('hidden');
                } else {
                    step3PricesSection.classList.add('hidden');
                }
                
                // Show/hide Inventory fields
                if (currentObjectType === 'Inventory') {
                    step3InventorySection.classList.remove('hidden');
                } else {
                    step3InventorySection.classList.add('hidden');
                }
                
                // Handle different UI states based on object type
                if (currentObjectType === 'VariationMapping') {
                    // Hide locale and attributes sections for Variation Mapping
                    variationMappingHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.remove('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                } else if (currentObjectType === 'ProductRecommendation') {
                    // Hide locale and attributes sections for Product Recommendation
                    productRecommendationHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.remove('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                } else if (currentObjectType === 'CategoryAssignment') {
                    // Hide locale and attributes sections for Category Assignment
                    categoryAssignmentHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.remove('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                } else if (currentObjectType === 'CategoryPosition') {
                    // Hide locale and attributes sections for Category Position
                    categoryPositionHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.remove('hidden');
                    imageMappingSection.classList.add('hidden');
                } else if (currentObjectType === 'VariationGroup') {
                    // Show locale and site sections for Variation Group (similar to Product)
                    variationGroupHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.remove('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.remove('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                    variationGroupSection.classList.remove('hidden');
                    pricesSection.classList.add('hidden');
                } else if (currentObjectType === 'ImageMapping') {
                    // Hide locale and attributes sections for Image Mapping
                    imageMappingHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.remove('hidden');
                    variationGroupSection.classList.add('hidden');
                    pricesSection.classList.add('hidden');
                } else if (currentObjectType === 'Prices') {
                    // Hide locale and attributes sections for Prices
                    pricesHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                    variationGroupSection.classList.add('hidden');
                    pricesSection.classList.remove('hidden');
                    inventorySection.classList.add('hidden');
                    productSetsSection.classList.add('hidden');
                } else if (currentObjectType === 'Inventory') {
                    // Hide locale and attributes sections for Inventory
                    inventoryHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                    variationGroupSection.classList.add('hidden');
                    pricesSection.classList.add('hidden');
                    inventorySection.classList.remove('hidden');
                    productSetsSection.classList.add('hidden');
                } else if (currentObjectType === 'ContentAsset') {
                    // Show content asset section for Content Assets
                    contentAssetHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.remove('hidden');
                    customAttributesSection.classList.remove('hidden');
                    contentAssetSection.classList.remove('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                    variationGroupSection.classList.add('hidden');
                    pricesSection.classList.add('hidden');
                    inventorySection.classList.add('hidden');
                    productSetsSection.classList.add('hidden');
                    
                defaultColumnHeader.textContent = `${currentObjectType} ID`;
                standardAttributesHeader.textContent = `Standard ${currentObjectType} Attributes`;
                customAttributesHeader.textContent = `Custom ${currentObjectType} Attributes`;
                    
                    // Initialize custom attributes table with one empty row
                    customAttributesTableBody.innerHTML = '';
                    addTableRow();
                    
                    // Load standard attributes for ContentAsset
                    renderStandardAttributes();
                    renderSelectedAttributes();
                } else if (currentObjectType === 'LibraryFolder') {
                    // Show library folder section for Library Folders
                    libraryFolderHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.remove('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                    variationGroupSection.classList.add('hidden');
                    pricesSection.classList.add('hidden');
                    inventorySection.classList.add('hidden');
                    productSetsSection.classList.add('hidden');
                } else if (currentObjectType === 'StaticCustomerGroup') {
                    // Show static customer group section for Static Customer Group
                    staticCustomerGroupHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.add('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.add('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.remove('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                    variationGroupSection.classList.add('hidden');
                    pricesSection.classList.add('hidden');
                    inventorySection.classList.add('hidden');
                    productSetsSection.classList.add('hidden');
                } else if (currentObjectType === 'ProductSets') {
                    // Show locale and site sections for Product Sets (similar to Product and Variation Groups)
                    productSetsHelp.classList.remove('hidden'); // Show help section
                    localeSection.classList.remove('hidden');
                    localeSectionMoved.classList.add('hidden');
                    siteSection.classList.remove('hidden');
                    siteSectionMoved.classList.add('hidden');
                    productAttributesDescription.classList.add('hidden');
                    attributesSection.classList.add('hidden');
                    customAttributesSection.classList.add('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                    variationGroupSection.classList.add('hidden');
                    pricesSection.classList.add('hidden');
                    inventorySection.classList.add('hidden');
                    productSetsSection.classList.remove('hidden');
                    
                    // Initialize attributes
                    productSetsCustomAttributes = [];
                    productSetsSelectedAttributes.clear();
                    clearProductSetsCustomAttributesTable();
                    renderProductSetsStandardAttributes();
                    renderProductSetsSelectedColumns();
                } else {
                    // Show locale, site, and attributes sections for Product, Category, and Customer
                    if (currentObjectType === 'Customer') {
                        // For Customer, hide locale and site sections, but show attributes
                        customerHelp.classList.remove('hidden'); // Show help section
                        localeSection.classList.add('hidden');
                        localeSectionMoved.classList.add('hidden');
                        siteSection.classList.add('hidden');
                        siteSectionMoved.classList.add('hidden');
                        productAttributesDescription.classList.add('hidden');
                    } else if (currentObjectType === 'Product') {
                        // For Product, show moved locale and site sections (below attributes), hide top sections
                        productAttributesDescription.classList.remove('hidden'); // Show help section
                        localeSection.classList.add('hidden');
                        localeSectionMoved.classList.remove('hidden');
                        siteSection.classList.add('hidden');
                        siteSectionMoved.classList.remove('hidden');
                    } else if (currentObjectType === 'Category') {
                        // For Category, show moved locale and site sections (below attributes), hide top sections
                        categoryAttributesHelp.classList.remove('hidden'); // Show help section
                        localeSection.classList.add('hidden');
                        localeSectionMoved.classList.remove('hidden');
                        siteSection.classList.add('hidden');
                        siteSectionMoved.classList.remove('hidden');
                        productAttributesDescription.classList.add('hidden');
                    }
                    
                    attributesSection.classList.remove('hidden');
                    customAttributesSection.classList.remove('hidden');
                    contentAssetSection.classList.add('hidden');
                    libraryFolderSection.classList.add('hidden');
                    staticCustomerGroupSection.classList.add('hidden');
                    variationMappingSection.classList.add('hidden');
                    productRecommendationSection.classList.add('hidden');
                    categoryAssignmentSection.classList.add('hidden');
                    categoryPositionSection.classList.add('hidden');
                    imageMappingSection.classList.add('hidden');
                    variationGroupSection.classList.add('hidden');
                    pricesSection.classList.add('hidden');
                    inventorySection.classList.add('hidden');
                    productSetsSection.classList.add('hidden');
                    
                    defaultColumnHeader.textContent = `${currentObjectType} ID`;
                    standardAttributesHeader.textContent = `Standard ${currentObjectType} Attributes`;
                    customAttributesHeader.textContent = `Custom ${currentObjectType} Attributes`;
                    
                    // Initialize custom attributes table with one empty row
                    customAttributesTableBody.innerHTML = '';
                    addTableRow();
                    
                    renderStandardAttributes();
                    renderSelectedAttributes();
                }
                
                dropZoneText.textContent = 'Drag & drop your CSV file here, or click to select a file.';
                conversionStatus.textContent = 'Ready to convert.';
                conversionStatus.classList.remove('text-red-500');
                generateXmlBtn.disabled = true;
                });
            });

            // CSV Generation Listeners
            localeCheckbox.addEventListener('change', (e) => {
                if (e.target.checked) {
                    localeDropdownContainer.classList.remove('hidden');
                } else {
                    localeDropdownContainer.classList.add('hidden');
                }
            });
            // Sync both site checkboxes
            siteCheckbox.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                siteCheckboxMoved.checked = isChecked;
                if (isChecked) {
                    siteInputContainer.classList.remove('hidden');
                    siteInputContainerMoved.classList.remove('hidden');
                } else {
                    siteInputContainer.classList.add('hidden');
                    siteInputContainerMoved.classList.add('hidden');
                }
            });
            
            siteCheckboxMoved.addEventListener('change', (e) => {
                const isChecked = e.target.checked;
                siteCheckbox.checked = isChecked;
                if (isChecked) {
                    siteInputContainer.classList.remove('hidden');
                    siteInputContainerMoved.classList.remove('hidden');
                } else {
                    siteInputContainer.classList.add('hidden');
                    siteInputContainerMoved.classList.add('hidden');
                }
            });
            
            // Sync both site ID inputs
            siteIdInput.addEventListener('input', (e) => {
                siteIdInputMoved.value = e.target.value;
            });
            
            siteIdInputMoved.addEventListener('input', (e) => {
                siteIdInput.value = e.target.value;
            });
            
            // Custom Attributes Table Listeners
            addRowBtn.addEventListener('click', () => addTableRow());
            clearTableBtn.addEventListener('click', clearCustomAttributesTable);
            applyCustomAttributesBtn.addEventListener('click', applyCustomAttributes);
            
            // Event delegation for remove buttons
            customAttributesTableBody.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-row-btn')) {
                    e.target.closest('tr').remove();
                }
            });
            
            standardAttributesContainer.addEventListener('change', (e) => { if (e.target.type === 'checkbox') handleAttributeToggle(e.target.value, e.target.checked); });
            selectedAttributesList.addEventListener('click', (e) => {
                const attrToRemove = e.target.dataset.attrRemove;
                if (attrToRemove) { selectedAttributes.delete(attrToRemove); renderSelectedAttributes(); renderStandardAttributes(); }
            });
            productSetsSelectedList.addEventListener('click', (e) => {
                const attrIndexToRemove = e.target.dataset.psAttrRemove;
                if (attrIndexToRemove !== undefined) {
                    productSetsCustomAttributes.splice(parseInt(attrIndexToRemove), 1);
                    renderProductSetsSelectedColumns();
                }
            });
            productSetsStandardAttributes.addEventListener('change', (e) => { if (e.target.type === 'checkbox') handleProductSetsAttributeToggle(e.target.value, e.target.checked); });
            generateSheetBtn.addEventListener('click', generateCSV);
            generateVariationCsvBtn.addEventListener('click', generateVariationMappingCSV);
            generateProductRecommendationCsvBtn.addEventListener('click', generateProductRecommendationCSV);
            generateCategoryAssignmentCsvBtn.addEventListener('click', generateCategoryAssignmentCSV);
            generateCategoryPositionCsvBtn.addEventListener('click', generateCategoryPositionCSV);
            generateImageMappingCsvBtn.addEventListener('click', generateImageMappingCSV);
            generateVariationGroupCsvBtn.addEventListener('click', generateVariationGroupCSV);
            generatePricesCsvBtn.addEventListener('click', generatePricesCSV);
            generateInventoryCsvBtn.addEventListener('click', generateInventoryCSV);
            generateLibraryFolderCsvBtn.addEventListener('click', generateLibraryFolderCSV);
            generateStaticCustomerGroupCsvBtn.addEventListener('click', generateStaticCustomerGroupCSV);
            generateProductSetsCsvBtn.addEventListener('click', generateProductSetsCSV);
            addProductSetsRowBtn.addEventListener('click', () => addProductSetsTableRow());
            clearProductSetsTableBtn.addEventListener('click', clearProductSetsCustomAttributesTable);
            applyProductSetsAttributesBtn.addEventListener('click', applyProductSetsCustomAttributes);
            
            // Event delegation for Product Sets remove buttons
            productSetsCustomAttributesTable.addEventListener('click', (e) => {
                if (e.target.closest('.remove-product-sets-row-btn')) {
                    e.target.closest('tr').remove();
                }
            });
            
            // Image Mapping Type Selection Listeners
            imageMappingTypeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'flat') {
                        flatImageContent.classList.remove('hidden');
                        variationImageContent.classList.add('hidden');
                    } else if (e.target.value === 'variation') {
                        flatImageContent.classList.add('hidden');
                        variationImageContent.classList.remove('hidden');
                    }
                });
            });

            // XML Conversion Listeners
            fileDropZone.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileDropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                fileDropZone.addEventListener(eventName, () => fileDropZone.classList.add('file-drop-zone-active'));
            });
            ['dragleave', 'drop'].forEach(eventName => {
                fileDropZone.addEventListener(eventName, () => fileDropZone.classList.remove('file-drop-zone-active'));
            });
            fileDropZone.addEventListener('drop', (e) => handleFileSelect(e.dataTransfer.files[0]));
            generateXmlBtn.addEventListener('click', generateXML);
            
            // --- Initial State ---
            generateSheetBtn.disabled = true;
            generateXmlBtn.disabled = true;

        });
    </script>
</body>
</html>